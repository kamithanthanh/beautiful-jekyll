---
layout : post 
title : BKSEC 2019  
--- 

# Má»Ÿ Ä‘áº§u  
ÄÃ¢y lÃ  kÃ¬ thi chá»n Ä‘á»™i tuyá»ƒn chuáº©n bá»‹ cho SVATTT 2019 sáº¯p diá»…n ra.Trong kÃ¬ thi mÃ¬nh feed quÃ¡, cáº£m tháº¥y trÃ¬nh pwn cÃ²n khÃ¡ cÃ¹i cáº§n rÃ¨n luyá»‡n thÃªm.  ğŸ˜¥ğŸ˜¥ğŸ˜¥ MÃ¬nh cÃ³ há»i hint anh **chung96vn** Ä‘á»ƒ lÃ m ná»‘t máº¥y bÃ i cÃ²n láº¡i vÃ  tá»•ng há»£p láº¡i. NÃ³i chung lÃ  cÅ©ng há»c Ä‘Æ°á»£c nhiá»u vÃ  cáº£m giÃ¡c cÃ³ Ä‘á»™ng lá»±c try hard hÆ¡n cho kÃ¬ thi sáº¯p tá»›i. ğŸ˜ğŸ˜ğŸ˜ Náº¿u khÃ´ng muá»‘n bá»‹ táº¡ch láº§n ná»¯a.   

# [**Play Around**](https://github.com/hacmao/hacmao.github.io/raw/master/Pwnable/BKSEC2019/playaround/play_around)    

ÄÃ¢y lÃ  bÃ i pwn Ä‘áº§u tiÃªn. Má»™t dáº¡ng bÃ i khÃ¡ quen thuá»™c vÃ  cÄƒn báº£n khi bÆ°á»›c vÃ o há»c pwnable.  

![](/Pwnable/BKSEC2019/playaround/hinh1.PNG)  

ChÃºng ta cÃ³ lá»—i trÃ n, stack thÃ¬ khÃ´ng cÃ³ canary nÃªn cÃ³ thá»ƒ trÃ n vá» Ä‘á»‹a chá»‰ trá»Ÿ vá» hÃ m ```vuln``` .   
CÃ´ng viá»‡c Ä‘áº§u tiÃªn lÃ  leak Ä‘Æ°á»£c libc. ChÃºng ta cÃ³ thá»ƒ ghi Ä‘Ã¨ lÃªn Ä‘á»‹a chá»‰ trá»Ÿ vá» Ä‘á»‹a chá»‰ plt cá»§a hÃ m printf vÃ  pass cho nÃ³ arguments lÃ  got cá»§a hÃ m ```printf```. NÃ³ sáº½ in ra Ä‘á»‹a chá»‰ cá»§a ```printf``` trong libc. Tá»« Ä‘Ã³ tÃ­nh toÃ¡n Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a libc. Äá»“ng thá»i cáº§n trá»Ÿ láº¡i hÃ m ```main``` 1 láº§n ná»¯a.   
Cá»¥ thá»ƒ payload sáº½ cÃ³ dáº¡ng : 
```python 
payload = "a" * (0x80 + 8) + ret + pop_rdi + p64(0x601018) + p64(bin.sym['printf']) + ret + p64(bin.sym['vuln'])
``` 
Trong kÃ¬ thi khÃ´ng hiá»ƒu vÃ¬ lÃ­ do magic gÃ¬ mÃ  thay Ä‘á»‹a chá»‰ cá»§a ```got.printf``` vÃ o láº¡i khÃ´ng in Ä‘Æ°á»£c. Bá» vÃ o debug rÃµ rÃ ng nÃ³ cÃ³ gá»i hÃ m printf rá»“i ğŸ˜±ğŸ˜±ğŸ˜± Test thá»­ báº±ng cÃ¡c Ä‘á»‹a chá»‰ khÃ¡c thÃ¬ váº«n in ra Ä‘Æ°á»£c. Tháº¿ lÃ  mÃ¬nh thá»­ báº±ng Ä‘á»‹a chá»‰ ```got.setbuf``` thÃ¬ láº¡i Ä‘Æ°á»£c. Loay hoay chá»— nÃ y cÅ©ng tá»‘n kha khÃ¡ thá»i gian .  
CÃ´ng viá»‡c cÃ²n láº¡i chá»‰ lÃ  gá»i hÃ m ```system``` thÃ´i.  

# [**Dead Note 1**](https://github.com/hacmao/hacmao.github.io/raw/master/Pwnable/BKSEC2019/deadnote1/Dead_Note_Lv1)  

ChÆ°Æ¡ng trÃ¬nh cÃ³ 2 hÃ m cÆ¡ báº£n ```add``` vÃ  ```del``` :  

![](/Pwnable/BKSEC2019/deadnote1/hinh1.PNG)   

![](/Pwnable/BKSEC2019/deadnote1/hinh2.PNG)  

![](/Pwnable/BKSEC2019/deadnote1/hinh3.PNG)   

HÃ m ```add``` cho phÃ©p chÃºng ta táº¡o má»™t vÃ¹ng heap size ```0x10``` vÃ  ghi khÃ´ng quÃ¡ 8 kÃ­ tá»± lÃªn Ä‘Ã³. Sau Ä‘Ã³ nÃ³ Ä‘Æ°á»£c check chá»‰ Ä‘Æ°á»£c ghi 0x3 kÃ­ tá»±.  
HÃ m ```del``` cho phÃ©p chÃºng phÃ©p chÃºng ta free má»™t con trá» vÃ  sau Ä‘Ã³ set láº¡i = 0.  

LÃºc Ä‘áº§u mÃ¬nh tÆ°á»Ÿng bÃ i nÃ y lÃ  ```heap``` cÆ¡ ğŸ˜‚ğŸ˜‚ğŸ˜‚ Sá»£ vl. Sau Ä‘Ã³ nhÃ¬n láº¡i cÃ³ lá»—i out of bound á»Ÿ hÃ m ```add```. ChÃºng ta cÃ³ thá»ƒ ghi Ä‘Ã¨ lÃªn GOT cá»§a 1 sá»‘ hÃ m trong Ä‘á»ƒ nÃ³ trá» vÃ o heap. Checksec thÃ¬ tháº¥y NX bá»‹ disable. Tá»©c lÃ  bÃ i nÃ y 90% lÃ  1 bÃ i shellcode. CÆ¡ mÃ  vÃ¬ nÃ³ filter cÃ³ 3 bytes nÃªn lÃ  Ä‘áº¿n Ä‘Ã¢y mÃ¬nh háº¿t Ã½ tÆ°á»Ÿng. Ä‚n hÃ nh suá»‘t máº¥y tiáº¿ng. VÃ¬ tá»« trÆ°á»›c Ä‘áº¿n giá» mÃ¬nh suy nghÄ© kiá»ƒu láº­p trÃ¬nh viÃªn, logic quÃ¡ nÃªn luÃ´n thá»«a nháº­n vÃ  lÃ m theo khuÃ´n khá»• cá»§a chÆ°Æ¡ng trÃ¬nh mÃ  khÃ´ng bao giá» Ä‘áº·t cÃ¢u há»i lÃ  cÃ³ thá»ƒ bypass cÃ¡i nÃ y khÃ´ng ? CÃ³ thá»ƒ lÃ m khÃ¡c Ä‘i Ä‘Æ°á»£c khÃ´ng ? ğŸ˜ğŸ˜ğŸ˜ Pwn toÃ n lÃ  cÃº lá»«a , Ä‘Ã´i khi nÃªn nghÄ© khÃ¡c biá»‡t Ä‘i tÃ­ thÃ¬ má»›i ra Ä‘Æ°á»£c.  
Sau khi nháº­n hint tá»« ```tÃ¡c giáº£``` thÃ¬ mÃ¬nh mÃ¬nh Ä‘Ã£ bypass Ä‘Æ°á»£c hÃ m strlen Ä‘á»ƒ nÃ³ luÃ´n tráº£ vá» 1. Tá»©c lÃ  ta cÃ³ shellcode 8 bytes.  

```c 
0:  31 c0                   xor    eax,eax
2:  c3                      ret
```

Äáº¿n Ä‘Ã¢y mÃ¬nh láº¡i gáº·p pháº£i váº¥n Ä‘á» ğŸ˜°ğŸ˜°ğŸ˜° lÃ  tá»« trÆ°á»›c Ä‘áº¿n giá» toÃ n cop shellcode trÃªn máº¡ng vá» cháº¡y mÃ  khÃ´ng hiá»ƒu rÃµ báº£n cháº¥t. Cháº£ cÃ³ shellcode nÃ o mÃ  ngáº¯n Ä‘áº¿n Ä‘á»™ 8 bytes cáº£. Thá»i gian tiáº¿p theo idea cá»§a mÃ¬nh lÃ  ghi Ä‘Ã¨ lÃªn hÃ m free shellcode. MÃ¬nh chia nhá» shellcode thÃ nh cÃ¡c Ä‘oáº¡n rá»“i cuá»‘i má»—i Ä‘oáº¡n mÃ¬nh Ä‘áº·t lá»‡nh jmp. Tuy nhiÃªn mÃ¬nh láº¡i gáº·p váº¥n Ä‘á» vá» Ä‘Æ°a chuá»—i ```/bin/sh``` vÃ o binary . Láº¡i tiáº¿p tá»¥c feed ğŸ˜°ğŸ˜°ğŸ˜°  
Sau khi nháº­n tiáº¿p hint tá»« tÃ¡c giáº£ thÃ¬ mÃ¬nh viáº¿t láº¡i shellcode 8 bytes Ä‘á»ƒ ghi Ä‘Ã¨ lÃªn hÃ m ```atoi```. VÃ¬ hÃ m ```atoi``` Ä‘Æ°á»£c truyá»n vÃ o con trá» lÃ  ```nptr``` , cÃ³ thá»ƒ lÃ  chuá»—i ```/bin/sh``` luÃ´n.  ğŸ˜ğŸ˜ğŸ˜ :  

```c
0:  50                      push   rax
1:  5a                      pop    rdx
2:  50                      push   rax
3:  5e                      pop    rsi
4:  34 3b                   xor    al,0x3b
6:  0f 05                   syscall
```  
Qua Ä‘Ã¢y mÃ¬nh há»c Ä‘Æ°á»£c thÃªm kÄ© nÄƒng viáº¿t shellcode lÃ  táº­n dá»¥ng nhá»¯ng con trá» Ä‘áº§u vÃ o Ä‘á»ƒ giáº£m thiá»ƒu Ä‘á»™ dÃ i cá»§a shellcode. TrÆ°á»›c khi vÃ o hÃ m ```atoi``` ta cÃ³ ```$rax = 0``` cho nÃªn ta táº­n dá»¥ng nÃ³ Ä‘á»ƒ set $rdx, $rsi = 0. Rá»“i gá»i ```sysexecve``` lÃ  cÃ³ shell.  

# [**Dead Note 2**](https://github.com/hacmao/hacmao.github.io/raw/master/Pwnable/BKSEC2019/deadnote2/Dead_Note_Lv2)  

Tiáº¿p tá»¥c vá»›i version 2 cá»§a bÃ i trÃªn. BÃ i nÃ y filter shellcode cá»§a chÃºng ta chá»‰ Ä‘Æ°á»£c cÃ³ ascii character.  

![](/Pwnable/BKSEC2019/deadnote2/hinh1.PNG)  

Tiáº¿p tá»¥c nháº­n hint tá»« tÃ¡c giáº£ ğŸ˜›ğŸ˜›ğŸ˜› thÃ¬ idea lÃ  ta pháº£i bypass ```speical read``` Ä‘á»ƒ cÃ³ thá»ƒ ghi Ä‘Ã¨ lÃªn strlen nhÆ° bÃ i trÆ°á»›c.  
ChÃºng ta chá»‰ cÃ³ 3 bytes vÃ  Ä‘á»u pháº£i lÃ  readable. Äá»ƒ cÃ³ má»™t hÃ m hoÃ n chá»‰nh thÃ¬ Ä‘áº§u tiÃªn pháº£i cÃ³ lá»‡nh ```ret```. MÃ  lá»‡nh ret láº¡i cÃ³ mÃ£ hex lÃ  ```\xc3``` tá»©c lÃ  kÃ­ tá»± khÃ´ng readble. TÃ¡c giáº£ hint lÃ  chÃºng ta cÃ³ thá»ƒ cÃ³ kÃ­ tá»± nÃ y á»Ÿ cÃ¡i size cuá»‘i cÃ¹ng cá»§a top chunk trong heap.  

![](/Pwnable/BKSEC2019/deadnote2/hinh2.PNG)   

Náº¿u chÃºng ta malloc Ä‘á»§ nhiá»u thÃ¬ tá»›i má»™t lÃºc nÃ o Ä‘Ã³ nÃ³ size trÃªn sáº½ cÃ³ chá»©a kÃ­ tá»± ```0xc3```. Ta Ä‘Ã£ cÃ³ kÃ­ tá»± ret. Giá» cáº§n set ```rax = 0```.  
Äáº·t breakpoint táº¡i ```0xE7D```  trÆ°á»›c khi strlen Ä‘á»ƒ xem tráº¡ng thÃ¡i cá»§a cÃ¡c thanh ghi xem chÃºng ta cÃ³ thá»ƒ táº­n dá»¥ng gÃ¬ tá»« Ä‘Ã³ khÃ´ng.  

![](/Pwnable/BKSEC2019/deadnote2/hinh3.PNG)   

Ta cÃ³ ```rax = 0x7fff149bcda0``` nhÆ° váº­y cáº§n set láº¡i rax. Tuy nhiÃªn cÃ¡c lá»‡nh ```xor rax, rax ```, ```mov rax, 0 ``` Ä‘áº¿u chá»©a cÃ¡c kÃ­ tá»± Ä‘áº·c biá»‡t. Äá»“ng thá»i, chÃºng ta Ä‘Ã£ pháº£i tá»‘n 2 bytes Ä‘á»ƒ nháº£y tá»›i lá»‡nh ```\xc3```. Tá»©c lÃ  chÃºng ta chá»‰ cÃ²n 1 lá»‡nh Ä‘á»ƒ set rax. Äiá»u Ä‘Ã³ lÃ  dÆ°á»ng nhÆ° lÃ  khÃ´ng thá»ƒ.  
Äá»ƒ Ã½ lÃ  rbx = 0, chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n push rbx, rá»“i pop rax Ä‘á»ƒ set rax = 0. 
```c
push rbx 
pop rax
```  
Váº«n cáº§n 2 bytes. NhÆ°ng nÃ³ lÃ  2 lá»‡nh riÃªng biá»‡t nÃªn chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n chia shellcode ra thÃ nh 2 láº§n jump rá»“i má»›i jmp Ä‘áº¿n ```\xc3```.  ğŸ˜ğŸ˜ğŸ˜ BÃ¹m bypass Ä‘Æ°á»£c strlen. NhÆ°ng strlen nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n trong Ä‘iá»u kiá»‡n ráº¥t Ä‘áº·c biá»‡t nÃªn chá»‰ cáº§n malloc 1 láº§n ná»¯a lÃ  táº¡ch. NÃªn trong láº§n tiáº¿p theo ta cáº§n overwrite láº¡i hÃ m strlen nhÆ° bÃ i trÆ°á»›c.  
Sau khi bypass Ä‘Æ°á»£c strlen luÃ´n tráº£ vá» 0 thÃ¬ hÃ m ```special_read``` khÃ´ng cÃ²n check kÃ­ tá»± Ä‘áº·c biá»‡t ná»¯a. LÃ m nhÆ° bÃ i trÆ°á»›c lÃ  ta cÃ³ shell.  

# [**Nobaby**](https://github.com/hacmao/hacmao.github.io/raw/master/Pwnable/BKSEC2019/nobaby/nobaby)  

BÃ i nÃ y lÃ  má»™t bÃ i heap. Cháº¡y trÃªn ubuntu 16.04 nÃªn khÃ´ng cÃ³ tcache. BÃ i nÃ y mÃ¬nh cÃ²n cháº³ng phÃ¡t hiá»‡n ra lá»—i nÃ o. BÃ i quÃ¡ nhiá»u nÃ£o vÃ  cÃº lá»«a.  
ChÆ°Æ¡ng trÃ¬nh cÃ³ 3 chá»©c nÄƒng chÃ­nh :  

![](/Pwnable/BKSEC2019/nobaby/hinh1.PNG)  

![](/Pwnable/BKSEC2019/nobaby/hinh2.PNG)   

![](/Pwnable/BKSEC2019/nobaby/hinh3.PNG)   

MÃ¬nh Ä‘á»c bÃ i nÃ y thÃ¬ khÃ´ng double free, NX thÃ¬ Ä‘Æ°á»£c báº­t nÃªn khÃ´ng thá»±c thi shellcode Ä‘Æ°á»£c. Chá»‰ cÃ³ má»™t lá»—i ``` out of bound ``` thÃ¬ dá»… nháº­n ra nháº¥t. NhÆ°ng nÃ³ cÅ©ng khÃ´ng giÃºp chÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i luá»“ng thá»±c thi cá»§a chÆ°Æ¡ng trÃ¬nh. Sau khi chai máº·t láº¡i Ä‘i há»i tÃ¡c giáº£ thÃ¬ mÃ¬nh cÅ©ng nháº­n ra Ä‘Æ°á»£c lá»—i tiáº¿p theo : ```double free```.  
Máº·c dÃ¹ con trá» Ä‘Ã£ Ä‘Æ°á»£c clear nhÆ°ng chÃºng ta cÃ³ thá»ƒ táº¡o ra 2 con trá» cÃ¹ng trá» vÃ o 1 Ä‘á»‹a chá»‰. Dá»±a trÃªn lá»—i chÃºng ta cÃ³ thá»ƒ trÃ n vÃ o biáº¿n node_count. Cá»¥ thá»ƒ :  
```
  - Äáº§u tiÃªn malloc 10 vÃ¹ng nhá»› Ä‘á»ƒ fill Ä‘áº§y 10 Ä‘á»‹a chá»‰ trong ```ptr```.   
  - Sau Ä‘Ã³ free 11 láº§n Ä‘á»ƒ reset ```node_count = -1```.  
  - Sau Ä‘Ã³ add tiáº¿p 2 láº§n thÃ¬ ghi Ä‘Ã¨ ```node_count = heap```.  
  - Tiáº¿n hÃ nh free 0x71 láº§n ptr[0] Ä‘á»ƒ ```node_count = ptr[9]```  
```


Äá»“ng thá»i chÃºng ta cÃ³ thá»ƒ leak Ä‘á»‹a chá»‰ libc báº±ng hÃ m ```show```. DÃ¹ng lá»—i ```out of bound``` Ä‘á»ƒ ptr trá» vá» 1 Ä‘á»‹a chá»‰ chá»©a Ä‘á»‹a chá»‰ GOT.LÃºc Ä‘áº§u do chÆ°a hiá»ƒu rÃµ Ä‘Æ°á»£c cáº¥u trÃºc file ELF nÃªn mÃ¬nh khÃ´ng biáº¿t cÃ³ cÃ¡i table nÃ y.  

![](/Pwnable/BKSEC2019/nobaby/hinh4.PNG)  

Chá»‰ cáº§n ```out of bound ``` vá» Ä‘Ã¢y lÃ  leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc.  
Sau khi cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc thÃ¬ viá»‡c cÃ²n láº¡i chá»‰ lÃ  lá»—i ```fastbin dupinto stack``` overwrite Ä‘á»‹a chá»‰ hÃ m malloc_hook thÃ nh one_gadget thÃ´i. MÃ¬nh cÃ³ viáº¿t 1 bÃ i tÆ°Æ¡ng tá»± á»Ÿ [Ä‘Ã¢y](https://hacmao.pw/Pwnable/heap/fastbin_dup_into_stack/) .  

# Káº¿t thÃºc  
NÃ³i chung lÃ  qua má»—i kÃ¬ thi mÃ¬nh láº¡i tháº¥y mÃ¬nh pháº¿ hÆ¡n xong cÅ©ng há»c Ä‘Æ°á»£c nhiá»u Ä‘iá»u hÆ¡n. ğŸ˜‰ğŸ˜‰ğŸ˜‰ Hope lÃ  cÃ³ thá»ƒ pass Ä‘Æ°á»£c vÃ²ng loáº¡i SVATTT láº§n nÃ y, máº·c dÃ¹ cÆ¡ há»™i lÃ  khÃ¡ mong manh.  



