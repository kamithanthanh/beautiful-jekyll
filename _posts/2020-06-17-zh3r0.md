---
layout : post
title : Zh3r0 CTF 2020 
--- 

## Má»Ÿ Ä‘áº§u  

Tá»± nhiÃªn cÃ³ giáº£i CTF giá»¯a tuáº§n lÃªn ngÃ³ xem tháº¿ nÃ o ğŸ˜ğŸ˜ğŸ˜ Giáº£i nÃ y tráº£i nghiá»‡m quáº£ khÃ´ng tá»‡, máº¥y bÃ i cá»§a nÃ³ cÅ©ng khÃ¡ hay, mÃ¬nh cÅ©ng há»c thÃªm Ä‘Æ°á»£c 1 sá»‘ thá»©.  

![](../img/2020-06-18-10-54-55.png)  

## Table of Contents  
 + [**[REVERSE] Fun**](#wu1) 
 + [**[PWN] Command-1**](#wu2)
 + [**[PWN] Help**](#wu3)
 + [**[PWN] \x32\x64**](#wu4)
 + [**[PWN] Command-2**](#wu5)

<a name="wu1"></a> 

## [REVERSE] Fun  
ChÆ°Æ¡ng trÃ¬nh lÃ  1 file crack-me ELF 64 bit :  

![](../img/2020-06-17-20-59-08.png) 

ChÆ°Æ¡ng trÃ¬nh thá»±c hiá»‡n má»™t lÆ°á»£ng cÃ´ng viá»‡c khÃ¡ lÃ  náº·ng ná» :  

![](../img/2020-06-17-20-59-47.png)   

Cuá»‘i cÃ¹ng lÃ  Ä‘oáº¡n so sÃ¡nh quen thuá»™c :  

![](../img/2020-06-17-21-00-31.png)  

PhÃ¢n tÃ­ch Ä‘oáº¡n cá»™ng trá»« mÃ£ hÃ³a kia, tiáº¿n hÃ nh Ä‘á»•i tÃªn Ä‘á»ƒ cho dá»… nhÃ¬n hÆ¡n dá»… hÃ¬nh dung hÆ¡n ğŸ˜‹  

![](../img/2020-06-17-21-03-48.png)  

Tá»« Ä‘Ã³ ta cÃ³ thá»ƒ Ä‘Æ°a ra káº¿t luáº­n lÃ  Ä‘oáº¡n mÃ£ hÃ³a láº±ng nháº±ng nÃ y thá»±c cháº¥t chá»‰ lÃ  viá»‡c Ä‘i xÃ¢y dá»±ng há»‡ phÆ°Æ¡ng trÃ¬nh báº­c nháº¥t 16 phÆ°Æ¡ng trÃ¬nh 16 áº©n. Do Ä‘Ã³ chÃºng ta sáº½ cÃ³ nghiá»‡m duy nháº¥t.  

BÃ i nÃ y cÃ³ 1 cÃ¡i trick lÃ  nÃ³ láº¡i khÃ´ng check háº¿t cáº£ 16 phÆ°Æ¡ng trÃ¬nh mÃ  chá»‰ check 9 cÃ¡i thÃ´i :)) Náº¿u chá»‰ dÃ¹ng Ä‘iá»u kiá»‡n 9 cÃ¡i thÃ¬ sáº½ khÃ´ng Ä‘á»§ dá»¯ liá»‡u Ä‘á»ƒ giáº£i ra nghiá»‡m. ğŸ˜ğŸ˜ğŸ˜ NhÆ°ng ngÆ°á»i ta cho cÃ¡i gÃ¬ cÅ©ng sáº½ cÃ³ lÃ­ do, nÃªn mÃ¬nh má»›i nghÄ© tá»›i viá»‡c check Ä‘á»§ cáº£ 16 cÃ¡i.  

Viá»‡c cÃ²n láº¡i lÃ  tÃ¬m Ä‘Æ°á»£c há»‡ phÆ°Æ¡ng trÃ¬nh nÃ y. MÃ¬nh ráº¥t thÃ­ch máº¥y bÃ i kiá»ƒu automatic reverse nÃ y,  viáº¿t code ráº¥t phÃª ğŸ˜€ MÃ¬nh Ä‘Æ°a ra 2 hÆ°á»›ng kháº£ thi :  
 + dÃ¹ng unicorn Ä‘á»ƒ cháº¡y vÃ  gen ra há»‡ phÆ°Æ¡ng trÃ¬nh
 + dÃ¹ng angr 

CÃ¡ch 1 cÃ³ thá»ƒ tá»‘n khÃ¡ nhiá»u giáº¥y má»±c khi cáº§n phÃ¢n tÃ­ch cáº¥u trÃºc cÃ¢u lá»‡nh nÃªn mÃ¬nh chá»n lá»±a chá»n 2 trÆ°á»›c.  

Do chÆ°Æ¡ng trÃ¬nh chá»‰ check 9 phÆ°Æ¡ng trÃ¬nh ko Ä‘á»§ dá»¯ kiá»‡n gÃ¬ Ä‘Ã³ mÃ  cháº¡y angr thuáº§n ko ra káº¿t quáº£ gÃ¬ Ä‘Æ°á»£c. ğŸ˜… Do mÃ¬nh chá»‰ lÃ  ngÆ°á»i Ä‘i sá»­ dá»¥ng tool nÃªn khÃ´ng hiá»ƒu Ä‘Æ°á»£c ná»n táº£ng thuáº­t toÃ¡n ngÆ°á»i ta sá»­ dá»¥ng nÃªn cÅ©ng khÃ´ng hiá»ƒu Ä‘Æ°á»£c vÃ¬ sao nÃ³ fail. CÃ³ thá»ƒ do quÃ¡ phá»©c táº¡p nÃªn nÃ³ khÃ´ng giáº£i Ä‘Æ°á»£c thÃ´i.  

NhÆ° Ã½ tÆ°á»Ÿng bÃªn trÃªn, hiá»‡n táº¡i chá»‰ cáº§n Ä‘i tÃ¬m Ä‘Æ°á»£c táº¥t cáº£ cÃ¡c há»‡ phÆ°Æ¡ng trÃ¬nh lÃ  Ä‘Æ°á»£c. Angr cÃ³ thá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ y ğŸ¤—ğŸ¤—ğŸ¤—  

Äáº§u tiÃªn, váº«n lÃ  cÃ¡c bÆ°á»›c setup quen thuá»™c :  

```python
import angr 
from claripy import *
p = angr.Project("./fun")
``` 

Tiáº¿p Ä‘áº¿n, chÃºng ta cáº§n táº¡o biáº¿n `x` Ä‘áº§u vÃ o lÃ  má»™t string gá»“m 16 kÃ­ tá»±. Táº¡o biáº¿n cho hÃ m main nÃªn ta cÃ³ thá»ƒ sá»­ dá»¥ng `entry_state` vÃ  `args`.    

```python
arg1 = BVS('arg1', 16*8)
state = p.factory.entry_state(args=['func', arg1])
```

Ta Ä‘á»‹nh nghÄ©a Ä‘iá»ƒm dá»«ng : 

![](../img/2020-06-17-21-15-55.png) 

```python
good = (0x403C74)
simgr = p.factory.simulation_manager(state) 
simgr.explore(find=good)
solution_state = simgr.found[0]
```

Äiá»ƒm dá»«ng sáº½ lÃ  ngay trÆ°á»›c Ä‘oáº¡n so sÃ¡nh, lÃºc nÃ y chÆ°Æ¡ng trÃ¬nh sáº½ thá»±c thi xong Ä‘oáº¡n sinh há»‡ phÆ°Æ¡ng trÃ¬nh nÃªn ta cÃ³ Ä‘Æ°á»£c táº¥t cáº£ cÃ¡c phÆ°Æ¡ng trÃ¬nh cáº§n thiáº¿t ğŸ˜ Máº·c dÃ¹ cháº£ biáº¿t nÃ³ nhÆ° nÃ o nhÆ°ng miá»…n lÃ  nÃ³ tá»“n táº¡i lÃ  Ä‘Æ°á»£c.  

Giai Ä‘oáº¡n tiáº¿p theo lÃ  láº­p há»‡ tá»« cÃ¡c phÆ°Æ¡ng trÃ¬nh Ä‘Ã£ cÃ³ :  

```python
for i in range(16) :  
    var = solution_state.memory.load(0x406060 + 4 * i, 4) 
    solution_state.solver.add(var == 0) 
```  

ChÃºng ta sáº½ láº¥y phÆ°Æ¡ng trÃ¬nh tá»« máº£ng `0x406060`, rá»“i táº¡o phÆ°Æ¡ng trÃ¬nh `==0`.  

Cuá»‘i cÃ¹ng, in flag ra thÃ´i :  

```python
print(b"zh3r0{%s}" % solution_state.solver.eval(arg1, cast_to=bytes))
```

![](../img/2020-06-17-21-19-18.png)  

CÃ²n 1 bÃ i reverse vá» `Rust` thÃ¬ thÃ´i Ã©o viáº¿t, ra Ä‘Æ°á»£c pháº§n Ä‘áº§u cá»§a flag xong Ä‘oÃ¡n pháº§n cÃ²n láº¡i. Táº¥u hÃ i vl :)) 

![](../img/2020-06-17-21-28-44.png) 

 

<a name="wu2"></a>

## [PWN] Command-1  

BÃ i nÃ y khÃ´ng biáº¿t cÃ³ pháº£i tÃ¡c giáº£ khÃ´ng filter hay ko :v CÃ’n ko pháº£i viáº¿t script python ná»¯a mÃ  netcat cÅ©ng xong luÃ´n.  

![](../img/2020-06-17-21-23-32.png)  


ChÆ°Æ¡ng trÃ¬nh cÃ³ 3 lá»±a chá»n :  
 + ThÃªm lá»‡nh
 + Cháº¡y lá»‡nh
 + Sá»­a lá»‡nh 

ThÃªm lá»‡nh nÃ³ sáº½ filter Ä‘á»ƒ chÃºng ta khÃ´ng cÃ³ Ä‘Æ°á»£c shell, cháº¡y lá»‡nh báº±ng hÃ m `system`.  
Tuy nhiÃªn, má»™t cÃ¡ch dá»… dÃ ng lÃ  cÃ³ thá»ƒ dÃ¹ng ` sá»­a lá»‡nh ` Ä‘á»ƒ nháº­p vÃ o chuá»—i `/bin/sh` vÃ  cÃ³ shell ğŸ˜‚ğŸ˜‚  

<a name="wu3"></a>  

## [PWN] Help  

ChÃºng ta cÃ³ má»™t lá»—i trÃ n 1 bytes :v 

![](../img/2020-06-17-21-30-21.png)  

NhÆ°ng do hÃ m nÃ y Ä‘Æ°á»£c gá»i báº±ng má»™t hÃ m ná»™i bá»™ nÃªn cÃ³ thá»ƒ dÃ¹ng 1 bytes nÃ y Ä‘á»ƒ chuyá»ƒn luá»“ng thá»±c thi sang hÃ m khÃ¡c :  

![](../img/2020-06-17-21-31-15.png)  

Táº¡i hÃ m nÃ y, ta cÃ³ lá»—i trÃ n dÃ i hÆ¡n tÃ­ : `0x18` bytes. Tuy nhiÃªn Ä‘Ã¢y lÃ  file 64 bit nÃªn nÃ³ cÅ©ng khÃ´ng Ä‘á»§ Ä‘á»ƒ lÃ m kiá»ƒu trÃ n thÃ´ng thÆ°á»ng.  

Ta cÃ³ hai chá»— Ä‘á»ƒ nháº­p string :  
 + stack : 0x40 bytes - 0x18 bytes Ä‘á»ƒ ROP 
 + bss : 0x60 bytes Ä‘á»ƒ ROP 

Sá»­ dá»¥ng kÄ© thuáº­t `stack pivot` nhÆ° Ä‘Ã£ nÃ³i á»Ÿ ngay writeup `NahamCTF` láº§n trÆ°á»›c, ta dÃ¹ng `leave;ret` Ä‘á»ƒ thá»±c hiá»‡n chuyá»ƒn luá»“ng thá»±c thi lÃªn bss.  

Táº¡i Ä‘Ã¢y, ta cÃ³ thá»ƒ Ä‘áº·t `pop_rdi+got+plt` Ä‘á»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc. Tiáº¿p Ä‘áº¿n, dá»± Ä‘á»‹nh Ä‘áº§u lÃ  quay trá»Ÿ láº¡i trá»±c tiáº¿p hÃ m `finallyyouhelpme` Ä‘á»ƒ cÃ³ thá»ƒ thá»±c hiá»‡n trÃ n tiáº¿p. Tuy nhiÃªn nÃ³ láº¡i hÃ nh Ä‘á»™ng ráº¥t láº¡ lol :))  

![](../img/2020-06-17-21-46-12.png)  

Maybe lÃ  vÃ¬ má»™t lÃ­ do nÃ o Ä‘Ã³. Tuy nhiÃªn, cÃ³ 1 hÆ°á»›ng Ä‘i khÃ¡c lÃ  ta setup láº¡i `rbp` thÃ nh `bss` vÃ  trá»Ÿ láº¡i hÃ m `read` :  

![](../img/2020-06-17-21-47-37.png)  

Táº¡i Ä‘Ã¢y, chÃºng ta váº«n cÃ³ lá»—i trÃ n nhÆ° trÃªn nÃªn cÃ³ thá»ƒ gá»i gadget :))  

<a name="wu4"></a>  

## [PWN] \x32\x64

BÃ i nÃ y lÃ  má»™t bÃ i khÃ¡ thÃº vá»‹, mÃ¬nh há»c Ä‘Æ°á»£c thÃªm vá» cÃ¡c kiáº¿n thá»©c vá» x32, x64 sau khi lÃ m bÃ i nÃ y. ğŸ˜€  
ChÆ°Æ¡ng trÃ¬nh Ä‘Æ°á»£c viáº¿t báº±ng thuáº§n asm.  

![](../img/2020-06-17-21-50-19.png)  

ChÆ°Æ¡ng trÃ¬nh cÃ³ 2 láº§n input : 
 + input 1 : `0x2C` bytes, cÃ³ 4 bytes trÃ n 
 + input 2 : `0x200` bytes lÃªn bss  

CÃ³ má»™t lá»‡nh khÃ¡ láº¡ lÃ m cho chÆ°Æ¡ng trÃ¬nh hÃ nh Ä‘á»™ng kÃ¬ láº¡ lÃ  `retfq`.  
Lá»‡nh nÃ y thá»±c cháº¥t vá»«a Ä‘á»ƒ `ret` láº¡i dÃ¹ng Ä‘á»ƒ chuyá»ƒn mode vá» `32bit` =))) áº¢o vcl. ğŸ˜… LÃºc Ä‘áº§u khÃ´ng biáº¿t cá»© debug loáº¡n lÃªn. Sau má»›i Ä‘Æ°á»£c admin hint lÃ  `Are you running on 32bit or 64bit` :v lÃªn google láº¡i kiáº¿m Ä‘Æ°á»£c 1 bÃ i wu vá» `retf`, nÃ³ nÃ³i lÃ  Ä‘á»ƒ change mode lÃºc nÃ y má»›i cháº¯c cháº¯n Ä‘Æ°á»£c.  

> 4 bytes trÃ n, ret vá» Ä‘Ã¢u ?  

LÆ°á»£n qua lÆ°á»£n láº¡i binary, tháº¥y cÃ³ má»™t Ä‘oáº¡n gadget khÃ¡ thÃº vá»‹ :  

![](../img/2020-06-17-21-54-58.png)  

NÃ³ lÃ  Ä‘oáº¡n gadget duy nháº¥t cho ta chá»§ Ä‘á»™ng set Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a `eax`. Thanh ghi `rdi` cÃ³ thá»ƒ kiá»ƒm soÃ¡t báº±ng sá»‘ byte nháº­p vÃ o trong láº§n input thá»© hai.  

Tá»« Ä‘Ã¢y, má»Ÿ ra nhiá»u hÆ°á»›ng táº¥n cÃ´ng : 
 + DÃ¹ng kÄ© thuáº­t `SROP`, mÃ¬nh Ä‘Ã£ Ä‘áº¿n Ä‘Æ°á»£c Ä‘oáº¡n setup cÃ¡c giÃ¡ trá»‹ cá»§a thanh ghi thÃ nh cÃ´ng nhÆ°ng khi thá»±c thi `int 80h` thÃ¬ bá»‹ lá»—i gÃ¬ Ä‘Ã³ ğŸ˜– 
 + DÃ¹ng cÃ¡c hÃ m nhÆ° `Open`, `Read`, `Write` Ä‘á»ƒ Ä‘á»c file flag, tuy nhiÃªn ta láº¡i chá»‰ set Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a `rdi` duy nháº¥t 1 láº§n, nÃªn cÃ¡ch nÃ y cÅ©ng bá»‹ loáº¡i bá». 
 + Cuá»‘i cÃ¹ng, gá»i `mprotect` Ä‘á»ƒ sá»­a quyá»n thá»±c thi cá»§a bss Ä‘á»ƒ cháº¡y shellcode.  

![](../img/2020-06-17-21-58-42.png) 

Äoáº¡n mÃ£ nÃ y cho phÃ©p chÃºng ta set táº¥t cáº£ thanh ghi cáº§n thiáº¿t cho 32bit nÃªn ta cÃ³ thá»ƒ thoáº£i mÃ¡i gá»i `mprotect`.  

Do sau Ä‘Ã³, chÃºng ta cáº§n `ret` tá»›i shellcode nÃªn cáº§n Ä‘áº·t giÃ¡ trá»‹ `rsi = rsp = shellcode_addr`.  Done ğŸ¥°  

<a name="wu5"></a>  

## [PWN] Command-2  

ÄÃ¢y lÃ  má»™t bÃ i heap Ä‘Æ¡n giáº£n.  

![](../img/2020-06-17-22-01-46.png)  

ChÃºng ta Ä‘Æ°á»£c add 1 size tÃ¹y Ã½ :  

![](../img/2020-06-17-22-03-32.png)  

Max lÃ  Ä‘Æ°á»£c 6 láº§n ğŸ˜—  

Äá»“ng thá»i, má»™t lá»—i khÃ¡ rÃµ rÃ ng lÃ  free mÃ  khÃ´ng zero con trá», dáº«n tá»›i lá»—i double free vÃ  use after free.  

![](../img/2020-06-17-22-04-17.png)

Vá»›i lá»—i `useafterfree`, chÃºng ta cÃ³ thá»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a libc.  
Do binary Ä‘Æ°á»£c thá»±c thi trÃªn phiÃªn báº£n ubuntu 18.04 nÃªn sáº½ cÃ³ tcache. Äá»ƒ leak Ä‘Æ°á»£c thÃ¬ ta cáº§n cáº¥p phÃ¡t má»™t chunk cÃ³ size Ä‘á»§ lá»›n. MÃ¬nh láº¥y lÃ  `0x600` cho cháº¯c, free nÃ³ rá»“i dÃ¹ng hÃ m `viewcommand` Ä‘á»ƒ in ra Ä‘á»‹a chá»‰ `main arena`. Báº±ng debug, tÃ¬nh toÃ¡n ngÆ°á»£c trá»Ÿ láº¡i Ä‘Æ°á»£c libc.  

Tiáº¿p Ä‘áº¿n lÃ  lá»—i `doublefree`, cÃ³ thá»ƒ dá»… dÃ ng táº­n dá»¥ng Ä‘á»ƒ ghi Ä‘Ã¨ lÃªn `free_hook`.  
Xong game. ğŸ˜  










