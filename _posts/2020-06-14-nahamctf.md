---
layout : post
title : NahamCon CTF 2020 
--- 

# Má»Ÿ Ä‘áº§u  

Khoáº£ng thá»i gian gáº§n Ä‘Ã¢y báº­n vÃ i viá»‡c nÃªn cÅ©ng khÃ´ng chÆ¡i CTF Ä‘Æ°á»£c nhiá»u :v MÃ¹a hÃ¨ láº¡i Ä‘áº¿n, hi vá»ng chÃºng ta cÃ³ thá»ƒ bá»©t phÃ¡ má»™t cÃ¡i gÃ¬ Ä‘Ã³ má»›i trong hÃ¨ nÃ y ğŸ˜ğŸ˜ğŸ˜ 
Tuáº§n nÃ y team Nupakachi cÃ³ chÆ¡i giáº£i Nahamcon CTF 2020 .  

![](../img/2020-06-14-10-57-18.png) 

Pwn cá»§a giáº£i nÃ y mÃ¬nh tháº¥y khÃ´ng quÃ¡ khÃ³ mÃ  cÅ©ng khÃ¡ lÃ  hay, má»›i máº» ğŸ˜€  

# Table of content  

 + [**[PWN] Shifts-ahoy**](#wu1) 
 + [**[PWN] Converyor**](#wu2) 
 + [**[PWN] Free-willy**](#wu3)  
 + [**[PWN] leet-xor**](#wu4) 

<a name="wu1"></a>
## Shifts-ahoy  
ÄÃ¢y lÃ  bÃ i mÃ¬nh cáº£m tháº¥y thÃº vá»‹ nháº¥t trong cÃ¡c bÃ i pwn. :v  

ChÆ°Æ¡ng trÃ¬nh bao gá»“m 2 hÃ m cÆ¡ báº£n  :  

![](../img/2020-06-14-11-01-52.png)  

HÃ m `encrypt` : 

![](../img/2020-06-14-11-02-21.png) 


HÃ m `decrypt` thÃ¬ khÃ´ng lÃ m gÃ¬ nhiá»u.  

ChÃºng ta cÃ³ thá»ƒ dá»… dÃ ng nháº­n ra lá»—i trÃ n á»Ÿ hÃ m encrypt. TÃ­nh toÃ¡n Ä‘á»™ trÃ n thÃ¬ chá»‰ trÃ n Ä‘Æ°á»£c tá»›i Ä‘á»‹a chá»‰ trá»Ÿ vá». Äiá»u nÃ y gÃ¢y khÃ³ khÄƒn cho viá»‡c ROP cá»§a chÃºng ta. ThÃ´ng thÆ°á»ng, chá»‰ cáº§n trÃ n tá»›i puts rá»“i leak Ä‘á»‹a chá»‰,trá»Ÿ vá» main vÃ  call `system`.  
Tuy nhiÃªn, nÃ³ cáº§n tá»›i 24 bytes trÃ n ká»ƒ tá»« Ä‘á»‹a chá»‰ trá»Ÿ vá», trong trÆ°á»ng há»£p nÃ y chÃºng ta láº¡i chá»‰ cÃ³ 8 bytes. ğŸ˜…  

Kiá»ƒm tra cÃ¡c cÆ¡ cháº¿ báº£o máº­t :  

![](../img/2020-06-14-11-06-45.png)  

KhÃ´ng cÃ³ NX, nhÆ° váº­y kháº£ nÄƒng cao bÃ i nÃ y sáº½ Ä‘i thá»±c thi shellcode. NhÆ°ng má»™t cÃ¢u há»i lÃ  ROP vá» Ä‘Ã¢u :v  

Do cÃ³ kháº£ nÄƒng sá»­ dá»¥ng shellcode nÃªn khÃ´ng cáº§n lo tá»›i viá»‡c leak libc ná»¯a. Vá»›i shellcode, ta luÃ´n cáº§n Ä‘áº·t ra 2 cÃ¢u há»i : 
 + Äáº·t á»Ÿ Ä‘Ã¢u? 
 + Cháº¡y nhÆ° nÃ o?  


Biáº¿n `Buf` cÃ³ Ä‘á»™ dÃ i khÃ¡ lá»›n, Ä‘á»§ chá»©a shellcode. NhÆ°ng nÃ³ náº±m trÃªn stack, vÃ  chÃºng ta láº¡i chÆ°a cÃ³ Ä‘á»‹a chá»‰ stack Ä‘á»ƒ nháº£y tá»›i.  

Tá»›i Ä‘Ã¢y, chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n má»™t kÄ© thuáº­t gá»i lÃ  `stack pivot`, thay Ä‘á»•i luá»“ng thá»±c thi cá»§a chÆ°Æ¡ng trÃ¬nh lÃªn má»™t vÃ¹ng nhá»› Ä‘Ã£ biáº¿t Ä‘á»‹a chá»‰, cá»¥ thá»ƒ lÃ  `bss`.  

![](../img/2020-06-14-11-11-16.png)  

LÆ°u Ã½, khi káº¿t thÃºc má»™t hÃ m, chÆ°Æ¡ng trÃ¬nh sáº½ thá»±c hiá»‡n xÃ³a frame cá»§a hÃ m vÃ  tráº£ láº¡i `rbp` cÅ©. NhÆ° váº­y, nhá» vÃ o viá»‡c trÃ n chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c `rbp`.  

Trong khi tÃ¬m kiáº¿m má»™t Ä‘á»‹a chá»‰ Ä‘á»ƒ trá»Ÿ vá», mÃ¬nh tháº¥y má»™t Ä‘oáº¡n khÃ¡ kháº£ thi :  
![](../img/2020-06-14-11-12-38.png)  

Khi gá»i láº¡i hÃ m `fgets`, nÃ³ sáº½ Ä‘á»c kÃ­ tá»± vÃ o vÃ¹ng nhá»› táº¡i `rbp-0x50`. MÃ  Ä‘á»‹a chá»‰ `rbp` do chÃºng ta control. ğŸ˜  

Sau Ä‘Ã³, nÃ³ tiáº¿p tá»¥c thá»±c thi chÆ°Æ¡ng trÃ¬nh, nhÆ°ng frame cá»§a hÃ m Ä‘ang lÃ  trÃªn bss. Má»™t Ä‘á»‹a chá»‰ ta Ä‘Ã£ biáº¿t. Vá»›i shellcode Ä‘áº·t táº¡i Ä‘Ã¢y, ta sáº½ ret Ä‘Æ°á»£c vá» shellcode :v  

Khi lÃ m, cáº§n lÆ°u Ã½ Ä‘áº¿n dáº¥u `newline`. Do hÃ m `fgets` nÃ³ chá»‰ nháº­n `0x5f` giÃ¡ trá»‹, do Ä‘Ã³ nhá»¯ng giÃ¡ trá»‹ thá»«a, nÃ³ sáº½ tá»± Ä‘á»™ng update cho `fgets` Ä‘áº±ng sau nÃªn ta ko thá»ƒ input gÃ¬ thÃªm Ä‘Æ°á»£c. Nháº­p Ä‘á»§ lÆ°á»£ng kÃ­ tá»± lÃ  Ä‘iá»u cáº§n thiáº¿t.  

<a name="wu2"></a>
## Converyor  

ChÆ°Æ¡ng trÃ¬nh cÃ³ 2 hÃ m cÆ¡ báº£n lÃ  `add_part` vÃ  `safety_check`.  

![](../img/2020-06-14-11-31-58.png)  

![](../img/2020-06-14-11-32-15.png)  

Vá»›i hÃ m `safety_check`, chÃºng ta cÃ³ thá»ƒ trÃ n tá»›i `Next` :  

![](../img/2020-06-14-11-33-01.png)  

CÃ¡c node nÃ y nÃ³ táº¡o thÃ nh liÃªn káº¿t Ä‘Æ¡n, khi kiá»ƒm soÃ¡t Ä‘Æ°á»£c con trá» `next`, chÃºng ta Ä‘Ã£ kiá»ƒm soÃ¡t Ä‘Æ°á»£c liÃªn káº¿t Ä‘Æ¡n nÃ y. Thay Ä‘á»•i nÃ³ thÃ nh Ä‘á»‹a chá»‰ `GOT` cá»§a má»™t hÃ m nÃ o Ä‘Ã³, dá»±a vÃ o hÃ m `puts` ta sáº½ leak Ä‘Æ°á»£c libc.  

Tiáº¿p Ä‘áº¿n, dÃ¹ng chá»©c nÄƒng sá»­a bÃªn dÆ°á»›i, sá»­a `GOT` thÃ nh hÃ m `system`.  

Trong bÃ i nÃ y, hÃ m `atoi` lÃ  lá»±a chá»n tá»‘t nháº¥t Ä‘á»ƒ thay Ä‘á»•i thÃ nh `system` vÃ¬ mÃ¬nh cÃ³ thá»ƒ kiá»ƒm soÃ¡t input truyá»n vÃ o thÃ nh `/bin/sh`.  
BÃ¹m ez shell ğŸ˜‚  


<a name="wu3"></a> 

## Free-willy  

CÃ¢u chuyá»‡n vá» nhá»¯ng chÃº cÃ¡ voi :v  
 
![](../img/2020-06-14-11-38-16.png)  

TrÃ´ng con cÃ¡ voi khÃ¡ lÃ  táº¿u.  
ChÆ°Æ¡ng trÃ¬nh cÃ³ 4 hÃ m cÆ¡ báº£n, tuy nhiÃªn ta chá»‰ cáº§n quan tÃ¢m tá»›i 3 hÃ m Ä‘áº§u tiÃªn :v  

![](../img/2020-06-14-11-38-48.png)  

HÃ m `adop_whale` cÃ³ nhiá»‡m vá»¥ táº¡o node cÃ³ struct nhÆ° sau :  

``` 
struct node{
    long int none;    <-- not use 
    long int pname;   <-- address of name 
    long int size; 
    long int type; 
}
```  


![](../img/2020-06-14-11-39-53.png) 

HÃ m `disown_whale` dÃ¹ng Ä‘á»ƒ free node, tuy nhiÃªn cÃ³ má»™t lá»—i nghiÃªm trá»ng lÃ  khÃ´ng clear con trá» giá»¯ Ä‘á»‹a chá»‰ cá»§a malloc cÃ³ thá»ƒ dáº«n tá»›i lá»—i `use after free` vÃ  `double free`.  

![](../img/2020-06-14-11-43-24.png)  

HÃ m `rename_whale` cho phÃ©p chÃºng ta chá»‰nh sá»­a node :  

![](../img/2020-06-14-11-44-04.png)  

Sau khi free 1 whale, náº¿u node Ä‘Ã³ khÃ´ng pháº£i lÃ  top chunk thÃ¬ trong tcache bin sáº½ cÃ³ node nhÆ° sau :  

```
pname -> pnode
```

NhÆ° váº­y khi ta xin cáº¥p phÃ¡t 1 chÃº cÃ¡ heo ná»¯a, Ä‘á»‹a chá»‰ cá»§a pnode cá»§a chÃº cÃ¡ heo nÃ y sáº½ lÃ  Ä‘á»‹a chá»‰ `pname` cá»§a chÃº cÃ¡ heo vá»«a bá»‹ xÃ³a Ä‘i, `pname` láº¡i lÃ  `pnode`.  

ChÃºng ta cÃ³ thá»ƒ dÃ¹ng chÃº cÃ¡ heo nÃ y vá»›i chá»©c nÄƒng chá»‰nh tÃªn Ä‘á»ƒ thay Ä‘á»•i giÃ¡ trá»‹ `pname` cá»§a chÃº cÃ¡ heo trÆ°á»›c thÃ nh `GOT`.  

Khi Ä‘Ã£ cÃ³ `GOT` thay cho Ä‘á»‹a chá»‰ main, dÃ¹ng chá»©c nÄƒng chá»‰nh sá»­a vá»›i 1 chÃº cÃ¡ heo khÃ´ng tá»“n táº¡i, ta sáº½ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc mÃ  khÃ´ng tá»•n hai Ä‘áº¿n node nÃ o.  

Khi leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc xong, dÃ¹ng chá»©c nÄƒng chá»‰nh sá»­a chÃº cÃ¡ heo Ä‘Ã£ xÃ³a Ä‘á»ƒ thay Ä‘á»•i `GOT` thÃ nh Ä‘á»‹a chá»‰ hÃ m `system`.  
Viá»‡c cÃ²n láº¡i chá»‰ lÃ  chá»n hÃ m nÃ o Ä‘á»ƒ thay Ä‘á»•i thÃ´i. Trong trÆ°á»ng há»£p nÃ y, hÃ m `free` lÃ  thÃ­ch há»£p nháº¥t vÃ¬ chÃºng ta cÃ³ thá»ƒ pass `/bin/sh` cho tÃªn cá»§a con cÃ¡ heo. ğŸ˜‹ğŸ˜‹ğŸ˜‹

<a name="wu4"></a>

# Leet haxor  

BÃ i nÃ y lÃ  má»™t bÃ i cung cáº¥p 2 chá»©c nÄƒng chuyá»ƒn Ä‘á»•i kÃ­ tá»± sang dáº¡ng leet xor. Tuy nhiÃªn láº¡i cÃ³ 1 lá»—i cÆ¡ báº£n lÃ  format string.  

![](../img/2020-06-14-11-52-36.png)  

Vá»›i viá»‡c sá»­ dá»¥ng ultimate Ä‘Æ°á»£c `printf`, viá»‡c exploit lÃ  khÃ¡ dá»… dÃ ng.  

MÃ¬nh dÃ¹ng Ä‘oáº¡n script tÆ°Æ¡ng tá»± nhÆ° nÃ y Ä‘á»ƒ thá»±c hiá»‡n ghi lÃªn `GOT` : 

```python
# len(payload) ~ 27
def format8(str) : 
    return str + '0' * (8 - len(str) % 8)

puts_got = 0x601018 
part1 = one_gadget & 0xffff
part2 = (one_gadget & 0xffff0000) >> 16
if part2 < part1 : 
    part2 += 1 << 17

payload = "%" + str(part1) + "x%12$hn%" + str(part2 - part1) + "x%13$hn"
payload = format8(payload) + p64(puts_got) + p64(puts_got+2)
```





