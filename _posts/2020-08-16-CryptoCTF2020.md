# Crypto CTF 2020 

![](../img/2020-08-16-11-00-28.png)  


Cuá»‘i tuáº§n nÃ y mÃ¬nh cÃ³ chÆ¡i CryptoCTF 2020 vÃ  káº¿t thÃºc vá»›i 7 challenges Ä‘Æ°á»£c hoÃ n thÃ nh ğŸ˜ KhÃ´ng pháº£i quÃ¡ tá»‡ vá»›i má»™t tháº±ng lÃ¢u rá»“i khÃ´ng chÆ¡i Crypto nhÆ° mÃ¬nh. CÃ²n khÃ¡ nhiá»u challenge mÃ¬nh chÆ°a thá»ƒ hoÃ n thÃ nh ğŸ˜‚ğŸ˜‚ vÃ  script bruteforce thÃ¬ váº«n cháº¡y xuyÃªn mÃ n Ä‘Ãªm mÃ  khÃ´ng biáº¿t bao giá» má»›i ra káº¿t quáº£. Sau giáº£i nÃ y, mÃ¬nh má»›i biáº¿t mÃ¡y mÃ¬nh cÃ²n yáº¿u hÆ¡n cáº£ `google cocacl`. sad =((  

# Table of contents  
 + [**Three ravens**](#wu1)  
 + [**Amsterdam**](#wu2)  
 + [**Gambler**](#wu3)  
 + [**Model**](#wu4)  
 + [**Abbot**](#wu5)  
 + [**Haven**](#wu6)  

<a name="wu1"></a>  

# Three ravens  

```python
def keygen(nbit):
	while True:
		p, q, r = [getPrime(nbit) for _ in range(3)]
		if isPrime(p + q + r):
			pubkey = (p * q * r, p + q + r)
			privkey = (p, q, r)
			return pubkey, privkey
```
ÄÃ¢y lÃ  má»™t challenge RSA Ä‘Æ¡n giáº£n. Vá»›i hÃ m `keygen` nhÆ° trÃªn. Ta tháº¥y public key Ä‘Æ°á»£c táº¡o thÃ nh tá»« hai thÃ nh pháº§n lÃ  `p*q*r` vÃ  `p+q+r`.  

Tá»›i Ä‘Ã¢y, cháº¯c cÃ³ báº¡n ráº¥t dá»… bá»‹ lá»«a khi follow vÃ o viá»‡c phÃ¢n tÃ­ch tÃ¬m `p, q,r` tuy nhiÃªn Ä‘iá»u Ä‘Ã³ lÃ  hoÃ n toÃ n khÃ´ng cáº§n thiáº¿t khi `p+q+r` lÃ  má»™t sá»‘ nguyÃªn tá»‘ vÃ  Ä‘Ã£ biáº¿t rÃµ giÃ¡ trá»‹.  

Do Ä‘Ã³, ta cÃ³ thá»ƒ quy vá» module lÃ  `p+q+r` rá»“i tÃ¬m phi cá»§a nÃ³ vÃ  giáº£i nhÆ° bÃ i toÃ¡n RSA thÃ´ng thÆ°á»ng.  

```
enc = pow(m, e, n) 
-> enc = enc % (p+q+r) === pow(m, e, p+q+r) 
```  

<a name="wu2"></a>  

## Amsterdam   

**Challenges** 

```python
def comb(n, k):
	if k > n :
		return 0
	k = min(k, n - k)
	u = reduce(operator.mul, range(n, n - k, -1), 1)
	d = reduce(operator.mul, range(1, k + 1), 1)
	return u // d 

def encrypt(msg, n, k):
    # part 1 
	msg = bytes_to_long(msg.encode('utf-8'))
	if msg >= comb(n, k):
		return -1
	m = ['1'] + ['0' for i in range(n - 1)]
	for i in range(1, n + 1):
		if msg >= comb(n - i, k):
			m[i-1]= '1'
			msg -= comb(n - i, k)
			k -= 1

	# part 2 
	m = int(''.join(m), 2)
	i, z = 0, [0 for i in range(n - 1)]
	c = 0
	while (m > 0):
		if m % 4 == 1:
			c += 3 ** i 
			m -= 1
		elif m % 4 == 3:
			c += 2 * 3 ** i
			m += 1
		m //= 2
		i += 1
	return c
```  

HÃ m `encrypt` cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh hai pháº§n : 
 + pháº§n 1 : mÃ£ hÃ³a dá»±a trÃªn hÃ m comb, chuyá»ƒn thÃ nh dáº¡ng bit nhÆ° kiá»ƒu cÆ¡ sá»‘ comb áº¥y :v  
 + pháº§n 2 : dáº¡ng dáº¡ng kiá»ƒu chuyá»ƒn vá» cÆ¡ sá»‘ 3 :v  

Viá»‡c cá»§a chÃºng ta lÃ  viáº¿t hÃ m Ä‘áº£o ngÆ°á»£c hai pháº§n nÃ y láº¡i.  

### Part 2  

Äá»‘i vá»›i part2, trÆ°á»›c háº¿t ta tÃ¬m phÃ¢n tÃ­ch cÆ¡ sá»‘ 3 cá»§a ciphertext cÃ³ dáº¡ng nhÆ° : c<sub>1</sub>c<sub>2</sub>c<sub>3</sub>...  

Tiáº¿p Ä‘áº¿n, ta tÃ­nh tá»« cuá»‘i lÃªn, xÃ©t 3 trÆ°á»ng há»£p :  

 + náº¿u `c<sub>i</sub> == 1` thÃ¬ `2 * m + 1` 
 + náº¿u `c<sub>i</sub> == 2` thÃ¬ `2 * m - 1`
 + náº¿u `c<sub>i</sub> == 0` thÃ¬ `2 * m + 0`  


### Part 1  

Sau khi dá»‹ch ngÆ°á»£c Ä‘Æ°á»£c part 2 ta thu Ä‘Æ°á»£c m lÃ  báº£n mÃ£ cá»§a part 1. Äá»ƒ dá»‹ch ngÆ°á»£c part 1, ta chuyá»ƒn `m` sang há»‡ nhá»‹ phÃ¢n rá»“i cÅ©ng thá»±c hiá»‡n cÃ´ng viá»‡c dá»‹ch ngÆ°á»£c tÆ°Æ¡ng tá»± nhÆ° viá»‡c chuyá»ƒn cÆ¡ sá»‘ váº­y Ä‘Ã³. KhÃ´ng cÃ³ gÃ¬ khÃ³ khÄƒn cáº£.  

<a name="wu3"></a>   

## Gambler  

BÃ i nÃ y cho phÃ©p chÃºng ta netcat Ä‘áº¿n má»™t server :  ` nc 05.cr.yp.toc.tf 33371`. Viá»‡c Ä‘áº§u tiÃªn, chÃºng ta cáº§n bypass thá»­ thÃ¡ch :  

```
Please submit a printable string X, such that sha1(X)[-6:] = f8496e and len(X) = 31
```  

ÄÃ¢y lÃ  cÃ´ng Ä‘oáº¡n nháº±m háº¡n cháº¿ bruteforce server ğŸ˜ğŸ˜ NhÆ°ng cÅ©ng gÃ¢y ráº¥t nhiá»u annoying cho ngÆ°á»i chÆ¡i. Khi mÃ  pháº£i Ä‘á»£i ráº¥t lÃ¢u.  

Äá»ƒ bypass Ä‘oáº¡n hash, mÃ¬nh xin Ä‘Æ°á»£c 1 script nhÆ° sau :  

```python

rx_hash = re.compile(b'Please submit a printable string X, such that (.*)\(X\)\[-6\:\] \= (.*) and len\(X\) \= (.*)')
# You must pass this PoW challenge :P')
t = remote(ip, port)
context.log_level = "debug"
resp = t.recvline();print(resp)
type_hash,valid_hash,len_mess = rx_hash.findall(resp)[0]
type_hash = eval(b'hashlib.'+type_hash)
valid_hash,len_mess = valid_hash.decode(),int(len_mess)
print(valid_hash,len_mess)
for test in itertools.product(string.printable,repeat=len_mess):
    tmp = ''.join(test).encode()
    if type_hash(tmp).hexdigest()[-6:]==valid_hash:    
        print("[+]Found:",tmp)
``` 

Aww waiting time ....  

![](../img/2020-08-16-11-35-47.png)  

Sau khi vÆ°á»£t qua challenges poc,chÃºng ta Ä‘áº¿n vá»›i chÆ°Æ¡ng trÃ¬nh chÃ­nh. 

![](../img/2020-08-16-11-37-16.png)  

CÃ³ 3 options Ä‘á»ƒ lá»±a chá»n :  
 + [**C**]ipher flag!
 + [**E**]ncryption function!
 + [**T**]ry the encryption!  


ChÃºng ta cÃ³ hÃ m mÃ£ hÃ³a khÃ¡ Ä‘Æ¡n giáº£n :  

```python
def encrypt(m, p, a, b):
    assert m < p and isPrime(p)
    return (m ** 3 + a * m + b) % p
```

VÃ  Ä‘á»“ng thá»i cÃ³ thá»ƒ dÃ¹ng hÃ m mÃ£ hÃ³a Ä‘á»ƒ mÃ£ hÃ³a giÃ¡ trá»‹ báº¥t kÃ¬.  
BÃ i nÃ y ta khÃ´ng biáº¿t gÃ¬ vá» `public key`. ÄÃ¢y lÃ  má»™t dáº¡ng `side-channel-attack`. Ta sáº½ sá»­ dá»¥ng hÃ m mÃ£ hÃ³a Ä‘á»ƒ thu Ä‘Æ°á»£c thÃ´ng tin khÃ¡c nhau.  

Äáº§u tiÃªn, chÃºng ta cáº§n tÃ¬m Ä‘Æ°á»£c `a, b, p`.  

### TÃ¬m b  

Ta mÃ£ hÃ³a vá»›i `m = 0`. Khi Ä‘Ã³, ta sáº½ thu láº¡i Ä‘Æ°á»£c m.  

### TÃ¬m a  

Ta mÃ£ hÃ³a vá»›i `m = 1`. Khi Ä‘Ã³, cipher text thu Ä‘Æ°á»£c sáº½ cÃ³ dáº¡ng ` 1 + a + b`. Ta láº¥y Ä‘Ã³ rá»“i trá»« Ä‘i `b` tÃ¬m Ä‘Æ°á»£c á»Ÿ bÆ°á»›c trÆ°á»›c lÃ  ra `a`. KhÃ´ng quan trá»ng Ã¢m dÆ°Æ¡ng vÃ¬ ta Ä‘ang thá»±c hiá»‡n cÃ¡c phÃ©p toÃ¡n trÃªn module `p`.  

### TÃ¬m p  

TrÆ°á»›c háº¿t cáº§n xÃ¡c Ä‘á»‹nh sá»‘ bit cá»§a `p`. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ y, ta chá»‰ cáº§n thá»­ mÃ£ hÃ³a cÃ¡c Ä‘oáº¡n vÄƒn báº£n cÃ³ sá»‘ bit cá»¥ thá»ƒ, náº¿u quÃ¡ lá»›n thÃ¬ sáº½ bá»‹ server tá»« chá»‘i. Sau khi lÃ m vÃ i cÃ´ng viá»‡c nhÃ m chÃ¡n Ä‘Ã³, ta tÃ¬m Ä‘Æ°á»£c Ä‘á»™ dÃ i bit cá»§a `p` lÃ  512.  
Äá»™ dÃ i cá»§a `a`, `b` khÃ¡ lÃ  xáº¥p xá»‰.  

Do Ä‘Ã³, ta sáº½ tiáº¿n hÃ nh mÃ£ hÃ³a má»™t sá»‘ lÃ m cho tá»•ng `m ** 3 + a * m + b` hÆ¡i vÆ°á»£t sá»‘ `p` Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c Ä‘á»“ng dÆ°.  

MÃ¬nh chá»n `m = 1024` do nÃ³ cÃ³ 10  bit.  

Sau Ä‘Ã³, chá»‰ cáº§n Ä‘i factor `m ** 3 + a * m + b - encrypt(m)`. Do sá»‘ Ä‘Ã³ cÃ³ má»™t Æ°á»›c nguyÃªn tá»‘ lÃ  `p` nÃªn cÃ¡c Æ°á»›c cÃ²n láº¡i ráº¥t bÃ©. Ta chá»‰ cáº§n Ä‘i tÃ¬m háº¿t cÃ¡c Æ°á»›c nguyÃªn tá»‘ bÃ© Ä‘Ã³ lÃ  ra Ä‘Æ°á»£c `p`.  

```python
def factor(n) : 
    i = 2
    while True : 
        if n % i != 0 : 
            i += 1 
            continue 
        n = n // i 
        if isPrime(n) :
            log.success("p = %d" % n) 
            return n 
        else : 
            i = 2
```

### TÃ¬m m  

Cuá»‘i cÅ©ng ta cÃ²n pháº£i Ä‘i giáº£i phÆ°Æ¡ng trÃ¬nh Ä‘á»“ng dÆ° :  
```
m ** 3 + a * m + b == c [mod p]  
```

Äá»ƒ giáº£i phÆ°Æ¡ng trÃ¬nh Ä‘á»“ng dÆ° nÃ y, ta cÃ³ thá»ƒ dÃ¹ng sage :  

```python
P.<x> = PolynomialRing(Zmod(p))
px = x^3 + a*x + b - enc
px.roots()
```

<a name="wu4"></a>  

## Model  

Challenge cho chÃºng ta má»™t káº¿t ná»‘i netcat : `nc 04.cr.yp.toc.tf 8001`.  

Sau khi káº¿t ná»‘i vá»›i server, ta thu Ä‘Æ°á»£c source code chÆ°Æ¡ng trÃ¬nh vÃ  public key cÅ©ng nhÆ° báº£n mÃ£ :  

```python
def genkey(nbit):
    while True:
        p, q = getPrime(nbit), getPrime(nbit)
        if gcd((p-1) // 2, (q-1) // 2) == 1:
            P, Q = (q-1) // 2, (p-1) // 2
            r = inverse(Q, P)
            e = 2 * r * Q  - 1
            return(p, q, e)

def encrypt(msg, pubkey):
    e, n = pubkey
    return pow(bytes_to_long(msg), e, n)
    
n = 22447939572660807243308311289931892388365003669295700536867549633516713302453449324551919078666579915228197329187957917606818773604750002085863795021573178205773106546180139131020488467079657935229154001115991655742518868268629188594620851356924003852790942275924974402283406526148241684608179444315229103426809357935934533678277547966131705128853300090054886642128377116887220743333192761043553517670906378741523287780365106472937165368086627194139603557301544166278454888781463977757454460941847745786162533949238314685730701370513058871625108253496496061141594580295085687778515092738688529611359937257490634009441
# encrypt(flag, pubkey) = 7077520491256532374746917092294372631159931429224627631277965754818470073050063217627949608886714162580335912377352526133928188875062304905216968707579647571827680185831458362793640116823151837815111529328335611637374040111401270720217810466002560778809452855267509199100924501274810986262278726223960807532548562269518378597625273153040483747771278104618407054256867157644515603610805802063844674910222372134224664069427433965202485777818826295907843818426157007476171522458334177501092523660821973889154502167708640003686344183269890123271408858838607997338568904026390772516584281907312300410645883428656930233120           

```  

BÃ i nÃ y cáº§n dÃ¹ng má»™t chÃºt tÃ­nh cháº¥t toÃ¡n há»c. NhÆ°ng cÅ©ng khÃ´ng pháº£i quÃ¡ phá»©c táº¡p ğŸ˜  

Lá»— há»•ng cá»§a bÃ i nÃ y náº±m á»Ÿ chá»— khÃ³a `e` Ä‘Æ°á»£c thiáº¿t láº­p tÃ­ch há»£p theo `private key`. Viáº¿t láº¡i `e` :  

```
e = 2 * r * Q - 1 = r * (p-1) - 1 
e == -1 [mod phi(p)]
```

Ta cÃ³ tÃ­nh cháº¥t khÃ¡ Ä‘áº·c biá»‡t cá»§a e, do Ä‘Ã³ náº¿u ta chá»‰ xÃ©t theo module p thÃ¬ vá»›i má»i báº£n mÃ£m ta cÃ³ :  
```
c = encrypt(m) = pow(m, e, n) [mod p] 
c = pow(m, -1, n) [mod p] 
m * c == 1 [mod p]  
```

Do Ä‘Ã³, ta cÃ³ `m * c - 1` lÃ  bá»™i cá»§a p vá»›i má»i m. Do Ä‘Ã³, ta cÃ³ thá»ƒ tiáº¿n hÃ nh mÃ£ hÃ³a ráº¥t nhiá»u báº£n rÃµ nhÆ° tháº¿, láº¥y Æ°á»›c chung lá»›n nháº¥t ta sáº½ cÃ³ cÆ¡ há»™i ráº¥t lá»›n Ä‘á»ƒ tÃ¬m láº¡i Ä‘Æ°á»£c `p`. ğŸ¤©  

Cuá»‘i cÃ¹ng, sau khi biáº¿t Ä‘Æ°á»£c p thÃ¬ má»i chuyá»‡n cÃ²n láº¡i khÃ´ng Ä‘Ã¡ng nháº¯c tá»›i.  

Má»™t bÃ i khÃ´ng quÃ¡ phá»©c táº¡p nhÆ°ng náº¿u khÃ´ng quen vá»›i sá»‘ há»c thÃ¬ maybe sáº½ hÆ¡i khÃ³ khÄƒn.  



<a name="wu5"></a>  

## Abbot  

BÃ i nÃ y mÃ¬nh nghÄ© cháº¯c ra nhá»¯ng lÃºc cuá»‘i nÃªn má»›i cÃ³ Ã­t ngÆ°á»i lÃ m Ä‘Æ°á»£c nhÆ° tháº¿. NhÃ¬n chung Ä‘Ã¢y lÃ  má»™t bÃ i rev :v CÃ³ chÃºt tÃ­nh cháº¥t sá»‘ há»c khÃ¡ thÃº vá»‹.  

ChÃºng ta cÃ³ 3 hÃ m mÃ£ hÃ³a khÃ¡ tÆ°Æ¡ng tá»± nhau Ä‘á»ƒ reverse. NÃ³i chung lÃ  dá»‹ch ngÆ°á»£c Ä‘Æ°á»£c má»™t thÃ¬ ta cÅ©ng dá»‹ch ngÆ°á»£c Ä‘Æ°á»£c cÃ¡c hÃ m cÃ²n láº¡i thÃ´i.  

```python
def me(msg):
	if len(msg) == 1 :
		return ord(msg)
	msg = msg[::-1]
	reducer = len(msg) - 1
	resultNum, resultDen = frac(ord(msg[0]), reducer).denominator, frac(ord(msg[0]), reducer).numerator
	reducer -= 1
	for i in range(1, len(msg)-1):
		result =  ord(msg[i]) +  frac(resultNum, resultDen)
		resultDen, resultNum  = result.denominator, result.numerator
		resultDen, resultNum =  resultNum, reducer * resultDen
		reducer -= 1	
	result = ord(msg[-1]) + frac(resultNum, resultDen)
	resultDen, resultNum  = result.denominator, result.numerator
	return (resultNum, resultDen)
``` 

TrÃ´ng qua hÃ m mÃ£ hÃ³a thÃ¬ khÃ¡ lÃ  phá»©c táº¡p khi nÃ³ dÃ¹ng tá»›i `fraction` vÃ  tiáº¿n hÃ nh Ä‘áº£o tá»­ sá»‘ vÃ  máº«u sá»‘ liÃªn tá»¥c. Äá»‘i vá»›i nhá»¯ng bÃ i nhÆ° nÃ y, cá»© lÃ m trÃªn nhá»¯ng trÆ°á»ng há»£p nhá» trÆ°á»›c Ä‘á»ƒ cÃ³ thá»ƒ cÃ³ cÃ¡i nhÃ¬n tá»•ng quÃ¡t vá» chÆ°Æ¡ng trÃ¬nh.  

Khi Ä‘á»c Ä‘á» bÃ i nÃ y, mÃ¬nh Ä‘Ã£ liÃªn há»‡ tá»›i ` liÃªn phÃ¢n sá»‘ `.  

![](../img/2020-08-16-12-02-36.png)  

Sau khi biáº¿n Ä‘á»•i kiá»ƒm chá»©ng vá»›i nhá»¯ng trÆ°á»ng há»£p nhá» thÃ¬ mÃ¬nh Ä‘Ã£ kháº³ng Ä‘á»‹nh Ä‘Æ°á»£c phá»ng Ä‘oÃ¡n trÃªn.  
Äá»‘i vá»›i hÃ m mÃ£ hÃ³a `me`, liÃªn phÃ¢n sá»‘ sáº½ cÃ³ dáº¡ng :  


![](../img/2020-08-16-12-09-05.png)  

Ta cÃ³ ciphertext bao gá»“m tá»­ sá»‘ vÃ  máº«u sá»‘. NhÆ° váº­y ta sáº½ cÃ³ :  

a<sub>0</sub> = denominator / numerator  

Sau Ä‘Ã³, ta tÃ­nh toÃ¡n láº¡i tá»­ sá»‘ vÃ  máº«u sá»‘ má»›i cá»§a pháº§n phÃ¢n sá»‘ cÃ²n láº¡i.  

Tiáº¿p Ä‘áº¿n ta thá»±c hiá»‡n tÃ­nh tiáº¿p a<sub>1</sub>, a<sub>2</sub> theo cÃ¡ch tÆ°Æ¡ng tá»±. BÃ i nÃ y lÃ m tay cÅ©ng Ä‘Æ°á»£c :v Tuy nhiÃªn hÃ m mÃ£ hÃ³a Ä‘Æ°á»£c chá»n ngáº«u nhiÃªn nÃªn lÃ m tay sáº½ máº¥t kha khÃ¡ thá»i gian. ğŸ˜‚ ThÃ´i thÃ¬ lÃ  dÃ¢n láº­p trÃ¬nh nÃªn ngáº¡i gÃ¬ mÃ  khÃ´ng viáº¿t hÃ m.  

Äáº¿n Ä‘oáº¡n nÃ y, vá»›i Ã½ tÆ°á»Ÿng , mÃ¬nh viáº¿t láº¡i dáº§n hÃ m mÃ£ hÃ³a. Äáº§u tiÃªn mÃ¬nh sáº½ viáº¿t hÃ m tÃ¬m Ä‘á»ƒ tÃ¬m a<sub>0</sub>.  

```python
msg = "" 
c = denominator // numerator   
resultDen, resultNum = den - c * num, den 
```
Sau Ä‘Ã³, ta tiáº¿n hÃ nh tá»•ng quÃ¡t lÃªn cho cÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i. ChÃº Ã½ lÃ  bÃ¢y giá» pháº£i thÃªm cÃ¡c chá»‰ sá»‘ 1,2,3 ... tÆ°Æ¡ng á»©ng vá»›i `reducer` á»Ÿ hÃ m mÃ£ hÃ³a. Äáº¿n Ä‘Ã¢y, ta cÃ³ thá»ƒ thá»­ báº±ng cÃ¡ch mÃ£ hÃ³a má»™t báº£n mÃ£ báº¥t kÃ¬ vÃ  tiáº¿n hÃ nh debug báº±ng cÃ¡ch in ra giÃ¡ trá»‹ `c` tÃ¬m Ä‘Æ°á»£c á»Ÿ má»—i bÆ°á»›c. Náº¿u giÃ¡ trá»‹ sai thÃ¬ ta thá»­ thay Ä‘á»•i má»™t chÃºt Ä‘á»ƒ nÃ³ thÃ nh Ä‘Ãºng :v  

Cuá»‘i cÃ¹ng sau khi kiá»ƒm tra vÃ  thá»­, mÃ¬nh tÃ¬m Ä‘Æ°á»£c hÃ m giáº£i mÃ£ :  

```python
def rev_me(num, den) : 
    increaser = 1 
    msg = "" 
    resultDen = den 
    resultNum = num 
    idx = 0  
    while True :
        idx += 1  
        c = increaser * resultDen // resultNum 
        resultNum, resultDen = increaser * resultDen - c * resultNum, resultNum
        msg += chr(c) 
        if resultNum == 0 : 
            break 
        if idx > 1 : 
            increaser += 1 
    return msg  
```

Subprise lÃ  nÃ³ khÃ¡ na nÃ¡ vá»›i hÃ m mÃ£ hÃ³a ğŸ˜® CÃ²n láº¡i 2 hÃ m thÃ¬ tÆ°Æ¡ng tá»±.  

Sau Ä‘Ã³ chÃºng ta chá»‰ cáº§n thá»­ láº§n lÆ°á»£t ba hÃ m giáº£i mÃ£ vá»›i báº£n mÃ£ Ä‘á»ƒ thu Ä‘Æ°á»£c flag cáº§n tÃ¬m.  

<a name="wu6"></a>  

## Haven  

![](../img/2020-08-16-12-20-39.png)  

`Hacmao has come to haven`. :v  

```python
def matthew_effect(shire, rohan):
    gandalf = ''
    for idx, hobbit in enumerate(shire):
        gandalf += oh if ord(hobbit) ^ ord(rohan[idx]) == 0 else no
    return gandalf


def born_to_die(isengard):
    luke = 0
    for book in new_testament:
        luke ^= ord(isengard[book])
    lizzy_grant = oh + isengard[:-1] if luke == 0 else no + isengard[:-1]
    return lizzy_grant

def encrypt(flag, key) : 
    len_flag = len(flag) 
    destiny = len_flag // len_key  
    apocalypse = len_flag % len_key
    _ = 0 
    princess_leia = ''
    while _ < destiny:
        princess_leia += matthew_effect(key,
                                    flag[_ * len_key: (_ + 1) * len_key])
        key = born_to_die(key)
        _ += 1

    princess_leia += matthew_effect(key[:apocalypse], flag[_ * len_key:]) 
    enc = bytes(int(princess_leia[i: i + 8], 2)
                      for i in range(0, len_flag, 8))
    return enc
```

BÃ i nÃ y tÃ¡c giáº£ cÃ³ váº» lÃ  fan hÃ¢m má»™ cá»§a ` chÃºa tá»ƒ cá»§a nhá»¯ng chiáº¿c nháº«n ``. NhÆ°ng Ä‘iá»u nÃ y láº¡i thÃ nh ra má»™t dáº¡ng obfuscate. KhÃ¡ lÃ  khÃ³ Ä‘á»c.  

Äá»“ng thá»i, bÃ i nÃ y cÃ³ khÃ¡ lÃ  nhiá»u biáº¿n bÃ­ máº­t :  

```python
from heaven import seventh_seal, oh, no, new_testament
```

Sau khi Ä‘á»c qua chÆ°Æ¡ng trÃ¬nh, cÃ³ thá»ƒ Ä‘Æ°a ra cÃ¡i nhÃ¬n tá»•ng quan lÃ  chÆ°Æ¡ng trÃ¬nh lÃ  má»™t kiá»ƒu mÃ£ hÃ³a dÆ°á»›i dáº¡ng bit.  

`seventh_seal` lÃ  key cÃ³ dáº¡ng bit vÃ  Ä‘á»™ dÃ i chÆ°a biáº¿t.  

`oh, no` lÃ  cÃ¡c bit 0 hoáº·c 1. Dá»±a vÃ o tÃªn mÃ¬nh máº¡nh dáº¡n Ä‘oÃ¡n `oh = 1 vÃ  no = 0`. Hoáº·c khÃ´ng thÃ¬ cÃ³ thá»ƒ thá»­ láº§n lÆ°á»£t cÅ©ng Ä‘Æ°á»£c ğŸ¤£  

`new_statement` kiá»ƒu lÃ  má»™t dáº¡ng Ä‘á»ƒ Ä‘áº£o bit. CÃ¡i mÃ  sau nÃ y mÃ¬nh quyáº¿t Ä‘á»‹nh `bruteforce` cho nÃ³ nhanh.  

`flag` cÃ³ dáº¡ng áº£nh. Do Ä‘Ã³, ta cÃ³ Ä‘Æ°á»£c know plain text lÃ  header cá»§a file jpg. File jpg cÃ³ 4 loáº¡i header :  

```python
jpg_header = b"\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46\x00\x01" 
#jpg_header = b"\xFF\xD8\xFF\xDB"
#jpg_header = b"\xFF\xD8\xFF\xEE"
#jpg_header = b"\xFF\xD8\xFF\xE1"
```

### TÃ¬m Ä‘á»™ dÃ i key  

BÆ°á»›c Ä‘áº§u tiÃªn, chÃºng ta cáº§n tÃ¬m Ä‘á»™ dÃ i cá»§a key.  

Key Ä‘Æ°á»£c thay Ä‘á»•i sau má»—i láº§n mÃ£ hÃ³a báº±ng hÃ m `born_to_die`.  

```python
lizzy_grant = oh + isengard[:-1] if luke == 0 else no + isengard[:-1]
```
Sau khi thay Ä‘á»•i nÃ³ sáº½ biáº¿n Ä‘á»•i tá»« dáº¡ng `axxxxx` sang `xxxxxxb`. NhÆ° váº­y, `key[1:] == newkey[:-1]`. Ta cÃ³ thá»ƒ dá»±a trÃªn thÃ´ng tin nÃ y Ä‘á»ƒ tÃ¬m Ä‘á»™ dÃ i key.  

HÃ m `matthew_effect` thá»±c cháº¥t hoáº¡t Ä‘á»™ng nhÆ° hÃ m `xor` . Do Ä‘Ã³, tá»« `known plaintext` ta cÃ³ thá»ƒ tÃ¬m láº¡i Ä‘Æ°á»£c key mÃ£ hÃ³a cho tá»«ng block.  

Váº­y nÃªn, táº¡i Ä‘Ã¢y ta sáº½ thá»­ láº§n lÆ°á»£t Ä‘á»™ dÃ i cá»§a key. Náº¿u Ä‘Ãºng , ta sáº½ thu Ä‘Æ°á»£c hai key cá»§a hai block liÃªn tiáº¿p thá»a mÃ£n Ä‘iá»u kiá»‡n : key<sub>1</sub>[1:] == key<sub>2</sub>[:-1].  

```python
bits = 4
while True : 
    print(bits)
    if bits > len(jpg_header) : 
        break 
    len_key = bits 
    key = matthew_effect(jpg_header[:len_key], flag_enc[:len_key]) 
    key_ = matthew_effect(jpg_header[len_key:2 * len_key], flag_enc[len_key:2 * len_key])
    if key[:-1] == key_[1:] : 
        print("Found : ", bits)
        break 
    bits += 1 
```
Äá»ƒ tÄƒng sá»± chÃ­nh xÃ¡c, cÃ³ thá»ƒ tÃ¬m nhiá»u key Ä‘á»ƒ kiá»ƒm tra Ä‘iá»u kiá»‡n trÃªn. Cuá»‘i cÃ¹ng, mÃ¬nh xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c key cÃ³ Ä‘á»™ dÃ i lÃ  19.  

### Bruteforce alll  

KhÃ´ng cáº§n biáº¿t nhiá»u vá» toÃ¡n, nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh bruteforce tá»« Ä‘Ã¢y. ChÃºng ta chá»‰ cáº§n bruteforce `new_statement`. NÃ³ cÃ³ Ä‘á»™ dÃ i lá»›n nháº¥t báº±ng Ä‘á»™ dÃ i cá»§a key. NhÆ° váº­y ta sáº½ cÃ³ nhiá»u nháº¥t lÃ  `2**19 = 524288`, khÃ´ng pháº£i lÃ  con sá»‘ quÃ¡ lá»›n.  

ÄÃ¢y lÃ  mÃ£ hÃ³a Ä‘á»‘i xá»©ng nÃªn hÃ m giáº£i mÃ£ cÅ©ng chÃ­nh lÃ  hÃ m mÃ£ hÃ³a. Ta sáº½ tiáº¿n hÃ nh giáº£i mÃ£ Ä‘áº¿n khi nÃ o tÃ¬m Ä‘Æ°á»£c flag á»Ÿ Ä‘Ãºng dáº¡ng `jpg`.  
MÃ¬nh viáº¿t má»™t hÃ m Ä‘á»ƒ check xem nÃ³ cÃ³ Ä‘Ãºng á»Ÿ dáº¡ng `jpg` khÃ´ng.  

```python
def check_jpg(string) : 
    
    if string[:3] == jpg_header[3] : 
        try : 
            image = Image.open(io.BytesIO(string))
            image.verify()
            return 1 
        except : 
            return 0  
```

Náº¿u chÃºng ta tiáº¿n hÃ nh giáº£i mÃ£ toÃ n bá»™ flag thÃ¬ sáº½ ráº¥t lÃ¢u do flag ráº¥t lá»›n, cho nÃªn ban Ä‘áº§u chá»‰ cáº§n giáº£i mÃ£ Ä‘oáº¡n Ä‘áº§u Ä‘á»ƒ check header thÃ´i.  
```python
flag = encrypt(flag_enc[:12*8], key) 
``` 
Sau Ä‘Ã³, Ä‘á»ƒ cho nhanh thÃ¬ mÃ¬nh check 3 kÃ­ tá»± Ä‘áº§u Ä‘á»ƒ xem nÃ³ cÃ³ Ä‘Ãºng vá»›i header cá»§a jpg khÃ´ng. Sau Ä‘Ã³ má»›i thá»±c hiá»‡n check báº±ng `pillow`.  
Náº¿u `image.verify()` Ä‘Ãºng thÃ¬ Ä‘Ã¢y Ä‘Ã­ch thá»±c lÃ  file áº£nh.  

Sau khi bruteforce xong, mÃ¬nh thu Ä‘Æ°á»£c file `flag.jpg`. :v  

# The End

Sau thá»i gian lÃ¢u khÃ´ng lÃ m crypto, mÃ¬nh tháº¥y khÃ¡ bá»‹ Ä‘uá»‘i vÃ  cÃ³ khÃ¡ nhiá»u kiáº¿n thá»©c má»›i mÃ  mÃ¬nh khÃ´ng biáº¿t. Do khÃ´ng Ä‘á»‹nh theo sÃ¢u nÃªn mÃ¬nh cÅ©ng coi Ä‘Ã³ lÃ  má»™t tráº£i nghiá»‡m Ä‘á»ƒ há»“i tÆ°á»Ÿng vá» thá»i gian Ä‘áº§u mÃ¬nh chÆ¡i CTF thÃ´i ğŸ˜ğŸ˜ğŸ˜ NhÆ°ng tráº£i qua 1 ngÃ y hoáº¡t Ä‘á»™ng liÃªn tá»¥c, mÃ¬nh cÅ©ng tháº¥y ráº¥t vui. ÄÃ¢y lÃ  má»™t trong hiáº¿m kÃ¬ ctf mÃ  mÃ¬nh try hard nhÆ° váº­y :v  
Maybe see you next year :v  Or not :v  

~ The end   

