---
layout : post 
title : Sharky CTF 2020 
--- 

# Má»Ÿ Ä‘áº§u  
Cuá»‘i tuáº§n nÃ y team Nupakachi cÃ³ chÆ¡i giáº£i Sharyky CTF 2020. MÃ¬nh Ä‘Ã¡nh giÃ¡ Ä‘á» cÅ©ng khÃ¡ hay vÃ  á»Ÿ má»©c Ä‘á»™ trung bÃ¬nh. Ráº£nh rá»—i láº¡i ngá»“i viáº¿t writeup vá» má»™t sá»‘ bÃ i mÃ¬nh lÃ m Ä‘Æ°á»£c trong cuá»™c thi.  

# Table of Content  

 + **[Crypto](#crypto)**  
   + [Noisy RSA](#noisy_rsa)  
   + [Heavy Computation](#heavy_computation)  
   + [Casino](#casino)  

 + **[Reverse](#reverse)**  
   + [Secure db](#securedb)  
   + [Miss Direction](#missdirection)  

 + **[Pwn](#pwn) 
   + [Captain hook](#captain)


<a name="crypto"></a>
# Crypto   
Crypto cÃ³ 3 bÃ i liÃªn quan Ä‘áº¿n toÃ¡n :v CÅ©ng khÃ¡ lÃ  hay vÃ  thÃº vá»‹. KhÃ´ng quÃ¡ khÃ³. (*ï¿£3ï¿£)â•­   

<a name="noisy_rsa"></a> 
## Noisy RSA   

Theo rule thÃ´ng thÆ°á»ng, public key sáº½ khÃ´ng thá»ƒ break. ChÃºng ta Ä‘Æ°á»£c cho `e`, `N`. VÃ  Ä‘oáº¡n mÃ£ hÃ³a :   

```python
rand = bytes_to_long(get_random_bytes(64))

ct = []
ct.append(encrypt(rand << 24))
flag = b"shk"
for car in flag:
	ct.append(noisy_encrypt(car,rand))
``` 

HÃ m `noisy_encrypt` lÃ  má»™t hÃ m mÃ£ hÃ³a RSA thÃ´ng thÆ°á»ng.  
NhÆ° váº­y, má»—i kÃ­ tá»± cá»§a flag Ä‘Æ°á»£c káº¿t há»£p vá»›i giÃ¡ trá»‹ `rand` kia. CÃ³ Ä‘Æ°á»£c rand lÃ  ta cÃ³ thá»ƒ break Ä‘Æ°á»£c mÃ£ hÃ³a nÃ y.  

```python
def noisy_encrypt(a,m):
	return encrypt(pow(a,3,N)+(m << 24))
``` 

Ta sáº½ quy mÃ£ hÃ³a trÃªn thÃ nh má»™t bÃ i toÃ¡n Ä‘Æ¡n giáº£n.  

![](../img/sharkyctf-1.png)
```
Cho 2 sá»‘ a, b Ä‘Ã£ biáº¿t. TÃ¬m x ?  
```
Do flag cÃ³ dáº¡ng `shkCTF` nÃªn ta hoÃ n toÃ n biáº¿t Ä‘Æ°á»£c a, b vÃ  Ä‘Æ°a vá» bÃ i toÃ¡n trÃªn.  

Do x < N nÃªn viá»‡c cáº§n lÃ m bÃ¢y giá» chá»‰ lÃ  triá»‡t tiÃªu báº­c mÅ© cá»§a x báº±ng cÃ¡c phÃ©p biáº¿n Ä‘á»•i tÆ°Æ¡ng Ä‘Æ°Æ¡ng.  

Äáº§u tiÃªn triá»‡t tiÃªu báº­c 3 báº±ng cÃ¡ch láº¥y phÆ°Æ¡ng trÃ¬nh (3), (2) trá»« Ä‘i phÆ°Æ¡ng trÃ¬nh (1).  

![](../img/sharkyctf-2.png)  

Sau Ä‘Ã³, tiáº¿p tá»¥c triá»‡t tiÃªu báº­c báº±ng cÃ¡ch nhÃ¢n phÆ°Æ¡ng trÃ¬nh (4) vá»›i b, phÆ°Æ¡ng trÃ¬nh (5) vá»›i b rá»“i trá»« cho nhau. Ta thu Ä‘Æ°á»£c :  

![](../img/sharkyctf-3.png)  

Giáº£i phÆ°Æ¡ng trÃ¬nh báº­c nháº¥t trÃªn ta thu Ä‘Æ°á»£c x cáº§n tÃ¬m. Sau Ä‘Ã³ Ä‘Æ¡n giáº£n lÃ  bruteforce tá»«ng kÃ­ tá»± Ä‘á»ƒ recovery flag thÃ´i.  


<a name="heavy_computation"></a>  
## Heavy Computation  

BÃ i nÃ y chÃºng ta cáº§n optimize Ä‘oáº¡n code :  

```python
for i in range(NB_ITERATIONS):
    start = start ** e
    start %= N

#We are never too cautious let's make it harder

key = 1
for i in range(NB_ITERATIONS):
    key = key ** e
    key %= N
    key *= start
    key %= N
```  

TrÆ°á»›c háº¿t cáº§n tÃ¬m phi N báº±ng sage ğŸ˜‚ Sage cÃ³ cÃ¡i built in Ä‘á»ƒ tÃ­nh phi nÃªn dÃ¹ng nÃ³ cho tiá»‡n.  
Sau Ä‘Ã³, Ä‘Æ¡n giáº£n lÃ  lÃ m chÃºt toÃ¡n há»c dá»±a trÃªn phi N thÃ´i.  

Solution :  

```python
def compute1(password) : 
    start = bytes_to_long(password.encode())
    e0 = pow(e, NB_ITERATIONS, phi)
    return pow(start, e0, N)


def compute2(start) : 
    e1 = (pow(e, NB_ITERATIONS, phi) - 1) * inverse(e-1, phi)
    return pow(start, e1, N)
``` 

## Casino  
BÃ i nÃ y khÃ¡ Ã­t ngÆ°á»i lÃ m Ä‘Æ°á»£c. ğŸ˜‚ KhÃ´ng hiá»ƒu sao.  

BÃ i nÃ y cho 1 file apk. ÄÃ¡p vÃ o `jadx` Ä‘á»ƒ decompile thÃ¬ ta tháº¥y nÃ³ cÃ³ hÃ m random trong java.  
Nhiá»‡m vá»¥ cá»§a chÃºng ta lÃ  nÃ³ cho trÆ°á»›c 2 sá»‘ Ä‘Æ°á»£c sinh ra báº±ng hÃ m random trong java. ChÃºng ta cáº§n tÃ­nh tÃ­ch cá»§a hai sá»‘ Ä‘Ã³. ÄÃºng thÃ¬ nÃ³ sáº½ cho chÃºng ta flag.  

LÃªn máº¡ng search má»™t tÃ­ vá» cÃ¡ch break hÃ m random trong java thÃ¬ ra ngay solution. ğŸ¤£ğŸ¤£ğŸ¤£ Life is ez.  

HÃ m java random cÃ²n dá»… break hÆ¡n hÃ m random trong python. Chá»‰ cáº§n 2 sá»‘ lÃ  ta cÃ³ thá»ƒ Ä‘oÃ¡n Ä‘Æ°á»£c sá»‘ tiáº¿p theo.  


<a name="reverse"></a>
# Reverse  

<a name="securedb"></a> 
## Secure DB  
ÄÃ¢y lÃ  1 bÃ i crackme file ELF 32 bit.  

File binary bá»‹ Ã¡p dá»¥ng kÄ© thuáº­t `anti disassemble` nÃªn ta khÃ´ng thá»ƒ dÃ¹ng F5 Ä‘á»ƒ Ä‘á»c source code.  

![](../img/sharkyctf-4.png)  

Táº¡i sao láº¡i cÃ³ thá»ƒ anti disassemble?  
VÃ¬ má»™t cÃ¢u lá»‡nh nÃ³ nháº£y ngÆ°á»£c láº¡i tÃ³i 1 Ä‘oáº¡n code gÃ¢y khÃ³ hiá»ƒu. Äiá»u kiá»‡n nháº£y luÃ´n luÃ´n xáº£y ra :  

```
xor eax, eax
jz ...
```  
NhÆ° váº­y, ta tiáº¿n hÃ nh `NOP` vÃ o 2 bytes táº¡i Ä‘á»‹a chá»‰ `80487B2`. Tá»©c lÃ  nÃ³ sáº½ thá»±c hiá»‡n cÃ¡c lá»‡nh sau lá»‡nh jmp luÃ´n. Do Ä‘Ã³ code sáº½ khÃ´ng bá»‹ reuse.  

Sau khi vÆ°á»£t qua táº¥t cáº£ cÃ¡c Ä‘oáº¡n `anti disassemble`, chÃºng ta cÃ³ thá»ƒ nháº¥n `P` Ä‘á»ƒ define láº¡i hÃ m `main` vÃ  nháº¥n `F5`.  

![](../img/sharkyctf-5.png)

ChÆ°Æ¡ng trÃ¬nh nháº­n Ä‘áº§u vÃ o lÃ  tÃªn file output. File nÃ y khi Ä‘iá»n Ä‘Ãºng key ta sáº½ táº£i vá» Ä‘Æ°á»£c 1 file `sqlite` chá»©a flag Ä‘á»ƒ Ä‘á»c.  

Input Ä‘Æ°á»£c nháº­p vÃ o táº¡i `byte_804D0C0` vÃ  Ä‘Æ°á»£c biáº¿n Ä‘á»•i báº±ng hÃ m `sub_8048A90`.  

![](../img/sharkyctf-6.png)  

HÃ m nÃ y gá»i thá»±c thi shellcode báº±ng lá»‡nh `call $+5`.  

![](../img/sharkyctf-7.png)  

Báº±ng debug, ta tháº¥y input Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng thuáº­t toÃ¡n xor vÃ  Ä‘Æ°á»£c lÆ°u trá»Ÿ láº¡i input :  

```
xor     al, [edi+edx]
xor     eax, ecx
cmp     esi, ebx
mov     [edi+edx], al
```  

Äáº·t break point táº¡i Ä‘oáº¡n xor Ä‘á»ƒ xem nÃ³ xor vá»›i cÃ¡i gÃ¬. Báº±ng debug, nháº­p cÃ¡c input khÃ¡c nhau thÃ¬ ta tháº¥y nÃ³ xor vá»›i cÃ¹ng 1 key cÃ³ Ä‘á»™ dÃ i 4.  
Náº¿u báº±ng thuáº­t toÃ¡n xor, chÃºng ta chá»‰ cáº§n cho Ä‘áº§u vÃ o lÃ  `target` cáº§n Ä‘áº¡t Ä‘Æ°á»£c Ä‘á»“ng thá»i Ä‘áº·t breakpoint táº¡i Ä‘oáº¡n so sÃ¡nh thÃ¬ ta sáº½ thu Ä‘Æ°á»£c key cáº§n tÃ¬m. ğŸ˜‹ğŸ˜‹ğŸ˜‹  

![](../img/sharkyctf-8.png)  

Láº¡ má»™t chá»— lÃ  lÃ m vá»›i file Ä‘Ã£ patch cÃ¡c kÄ© thuáº­t anti disassemble thÃ¬ nÃ³ ra káº¿t quáº£ sai. Cháº¯c mÃ¬nh Ä‘Ã£ bá» lá»¡ gÃ¬ Ä‘Ã³. ğŸ˜ Tuy nhiÃªn thuáº­t toÃ¡n váº«n lÃ  xor . Váº«n Ä‘áº·t breakpoint nhÆ° trÃªn.   

![](../img/sharkyctf-9.png)  

VÃ  cÃ³ key :   

![](../img/sharkyctf-10.png)  

Äiá»n Ä‘Ãºng key thu Ä‘Æ°á»£c file sqlite. Má»Ÿ báº±ng tool online nÃ o Ä‘Ã³ rá»“i Ä‘á»c flag tá»« database thÃ´i ğŸ˜ğŸ˜ğŸ˜  


<a name="missdirection"></a> 

## Miss direction  

Láº¡i lÃ  má»™t bÃ i crackme trÃªn ELF 32 bit.  

HÃ m main :  

![](../img/sharkyctf-11.png)  

HÃ m check key :  

![](../img/sharkyctf-12.png)  

Náº¿u Ä‘Ãºng sáº½ in ra flag :  

![](../img/sharkyctf-13.png)  

THuáº­t toÃ¡n check chá»‰ lÃ  thuáº­t toÃ¡n xor. VÃ¬ váº­y thá»±c hiá»‡n xor ngÆ°á»£c láº¡i thÃ¬ káº¿t quáº£ lÃ  má»™t Ä‘oáº¡n text troll ğŸ˜‘ğŸ˜‘ğŸ˜‘  

CÃ³ váº» nhÆ° cÃ³ gÃ¬ Ä‘Ã³ xáº£y ra trÆ°á»›c khi chÆ°Æ¡ng trÃ¬nh Ä‘Æ°á»£c thá»±c hiá»‡n. BÃ i nÃ y lÃ  má»™t bÃ i liÃªn quan tá»›i anti debug.  

`TlsCallback_0` lÃ  má»™t hÃ m luÃ´n luÃ´n Ä‘Æ°á»£c thá»±c hiá»‡n trÆ°á»›c hÃ m main. VÃ¬ váº­y, hÃ m nÃ y cÃ³ thá»ƒ lÃ m thay Ä‘á»•i dá»¯ liá»‡u, thay Ä‘á»•i flag cÃ¡c kiá»ƒu. Do Ä‘Ã³ cáº§n phÃ¢n tÃ­ch nÃ³ ğŸ™„  

Äáº§u tiÃªn, hÃ m nÃ y thá»±c thi má»™t hÃ m :  

![](../img/sharkyctf-14.png)  

HÃ m nÃ y Ä‘á»c tá»« fs:18h. NÃ³ lÃ  `PEB` hay gÃ¬ Ä‘Ã³ ğŸ˜‚ khÃ´ng nhá»› láº¯m. NÃªn nÃ³ lÃ  1 cÃ¡i anti debug. `Nop` nÃ³ â‰¡(â–”ï¹â–”)â‰¡   

`Nop` háº¿t Ä‘oáº¡n Ä‘áº§u cho ráº±ng nÃ³ lÃ  debug :)).Tiáº¿p Ä‘áº¿n, nÃ³ thá»±c thi má»™t hÃ m Ä‘Ã¡ng nghi ğŸ™‚ Patch Ä‘oáº¡n debug tháº¿ nÃ o cÅ©ng pháº£i cho nÃ³ vÃ o thá»±c thi hÃ m nÃ y thÃ¬ má»›i Ä‘Æ°á»£c.  



![](../img/sharkyctf-15.png)

![](../img/sharkyctf-16.png)  

HÃ m nÃ y láº¡i thá»±c thi má»™t hÃ m :  

![](../img/sharkyctf-17.png)  

HÃ m nÃ y thá»±c hiá»‡n decode gÃ¬ Ä‘Ã³ táº¡i hÃ m `401440`. HÃ m nÃ y lÃ  hÃ m áº©n. Thuáº­t toÃ¡n decode thÃ¬ khÃ´ng cáº§n care. Chá»‰ cáº§n Ä‘áº·t breapoint táº¡i hÃ m `sub_401440` lÃ  Ä‘Æ°á»£c.  

Lá»‡nh Ä‘áº§u tiÃªn cá»§a hÃ m nÃ y hÆ¡i fake. Cho nÃªn chÃºng ta dÃ¹ng lá»‡nh `C` Ä‘á»ƒ define cÃ¡c lá»‡nh cÃ²n láº¡i.  

![](../img/sharkyctf-18.png)  

DÃ¹ng lá»‡nh `P` Ä‘á» define hÃ m rá»“i `F5`. Ta thu Ä‘Æ°á»£c má»™t hÃ m check tÆ°Æ¡ng tá»± nhÆ° hÃ m `main`.  

ÄÃ¢y lÃ  target :   

![](../img/sharkyctf-19.png)

ÄÃ¢y lÃ  Ä‘oáº¡n mÃ£ hÃ³a :   

![](../img/sharkyctf-20.png)  

Dá»‹ch ngÆ°á»£c giá» lÃ  khÃ¡ dá»… dÃ ng. ğŸ˜ğŸ˜ğŸ˜  


<a name="pwn"></a>  

# PWN  

CÃ¡c bÃ i khÃ¡c ráº¥t basic cÃ²n bÃ i cÃ²n láº¡i reverse code khÃ¡ dÃ i nÃªn mÃ¬nh khÃ´ng lÃ m ğŸ˜…ğŸ˜…ğŸ˜… Viáº¿t á»Ÿ Ä‘Ã¢y bÃ i `Captain hook` thÃ´i.   

<a name="captain"></a>  

## Captain hook  

Nghe tÃªn `hook` cháº¯c tÃ¡c giáº£ Ä‘á»‹nh dÃ¹ng cÃ¡ch ghi Ä‘Ã¨ lÃªn `malloc_hook` hoáº·c `free_hook` gÃ¬ Ä‘Ã³. NhÆ°ng khÃ´ng cáº§n. Vá»›i lá»—i format string thÃ¬ chÃºng ta cháº£ cáº§n Ä‘á»™ng gÃ¬ tá»›i heap cáº£. ğŸ˜‚  

`Nghe thÃ¬ ráº¥t heap nhÆ°ng láº¡i lÃ  format string`.  

ChÆ°Æ¡ng trÃ¬nh cÃ³ cÃ¡c chá»©c nÄƒng nhÆ° sau :  

![](../img/sharkyctf-21.png)   

CÃ¡c node Ä‘Æ°á»£c thiáº¿t káº¿ theo struct :   

```c
struct node {
    int age; 
    char [32] name; 
    char [32] date; 
} 
``` 

ChÃºng ta cÃ³ má»™t lá»—i format string náº±m á»Ÿ hÃ m `read_character_infos`.  

![](../img/sharkyctf-22.png)   

Tuy nhiÃªn, nÃ³ bá»‹ fitler bá»Ÿi hÃ m `check_date_format`.  

![](../img/sharkyctf-23.png)  

NÃ³ check 10 kÃ­ tá»± Ä‘áº§u sao cho pháº£i thá»a mÃ£n Ä‘á»‹nh dáº¡ng : `DD/MM/YYYY`.  
VÃ¬ váº­y, khÃ´ng thá»ƒ dÃ¹ng trá»±c tiáº¿p lá»—i format string nÃ y Ä‘Æ°á»£c.  

Lá»—i tiáº¿p theo náº±m á»Ÿ hÃ m `edit_character`.  

![](../img/sharkyctf-24.png)  

ChÃºng ta cÃ³ thá»ƒ sá»­a `name`, `age`, `date`. Äiá»ƒm Ä‘Ã¡ng chÃº Ã½ á»Ÿ Ä‘Ã¢y lÃ  khi sá»­a `name` vÃ  `date` Ä‘á»u dÃ¹ng chung 1 biáº¿n ná»™i bá»™ `s2`, hÃ m Ä‘á»c vÃ o lÃ  hÃ m `read`. Váº­y nÃªn nÃ³ sáº½ khÃ´ng bá»‹ `null` terminate. Tiáº¿p Ä‘áº¿n, hÃ m `strncpy` update `date` láº¡i copy 0x20 bytes tá»« biáº¿n nÃ y. VÃ¬ váº­y, ta cÃ³ thá»ƒ edit `name = 'a' * 0xa + '%x'` sáº½ Ä‘Æ°á»£c lá»—i format string.  

Vá»›i lá»—i format string nÃ y, chÃºng ta cÃ³ thá»ƒ leak Ä‘á»‹a chá»‰ cá»§a stack -> return address cá»§a main.  

DÃ¹ng lá»—i nÃ y Ä‘á»ƒ ghi Ä‘Ã¨ lÃªn Ä‘á»‹a chá»‰ trá»Ÿ vá» thÃ nh `one_gadget`.  

CÃ³ khÃ³ khÄƒn tÃ­ lÃ  buffer khÃ¡ lÃ  nhá». CÃ³ 22 bytes Ä‘á»ƒ thá»±c hiá»‡n ghi. NÃªn ta chá»‰ cÃ³ thá»ƒ ghi tá»«ng bytes má»™t vá»›i `$hhn`.  








