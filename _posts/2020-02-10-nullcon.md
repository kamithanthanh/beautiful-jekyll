---
layout : post
title : Nullcon Hackim CTF 2020
---

# Check Solve    
 - SOlved :   
   + [**[CRYPTO] rps**](#wu1)      
   + [**[CRYPTO] ayyMessage**](#wu2)   
   + [**[RE] years 3000**](#wu3)   
   + [**[PWN] kid**](#wu4)     
 
  - UnS0lved (but read writeup so list here)  
    + [**[PWN] Dark Honya**](#wu5)    
<a name="wu1"></a>   
ğŸ‘ŠğŸ‘†ğŸ¤² 
# [CRYPTO] rps    
BÃ i nÃ y lÃ  má»™t bÃ i hash , nhÆ°ng hash láº¡i cÃ³ thá»ƒ dá»‹ch ngÆ°á»£c Ä‘Æ°á»£c nÃªn khÃ´ng cÃ³ gÃ¬ khÃ³ cáº£ :)))) 

<a name="wu2"></a>  
ğŸ‘ŠğŸ‘†ğŸ¤²
# [CRYPTO] ayyMessage   

BÃ i nÃ y lÃ  má»™t bÃ i ECC digital signature + AES CTR. ChÃºng ta Ä‘Æ°á»£c cho má»™t Ä‘oáº¡n mÃ£ hÃ³a.   
 + ECC digital signature : ta cÃ³ thá»ƒ dá»… dÃ ng pass vÃ¬ cÃ³ thá»ƒ thay Ä‘á»•i public key thÃ nh key mÃ¬nh tá»± gen.   
 + AES CTR :    

![](https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/CTR_decryption_2.svg/601px-CTR_decryption_2.svg.png)      

Sau khi Ä‘Ã£ giáº£ chá»¯ kÃ­, chÃºng ta cÃ³ thá»ƒ giáº£i mÃ£ báº¥t kÃ¬ Ä‘oáº¡n message nÃ o vÃ  thu Ä‘Æ°á»£c SHA256 cá»§a nÃ³.  
Äáº§u tiÃªn, ta thá»±c hiá»‡n mÃ£ hÃ³a Ä‘oáº¡n mÃ£ má»™t kÃ­ tá»±. Sau Ä‘Ã³ bruteforce tá»« 0 -> 256 Ä‘á»ƒ tÃ¬m ra Ä‘Æ°á»£c Ä‘oáº¡n giáº£i mÃ£ p cá»§a nÃ³. Ta thu Ä‘Æ°á»£c D(aeskey, nonce) = p xor m.   
Tiáº¿p tá»¥c lÃ m nhÆ° váº­y, ta thu Ä‘Æ°á»£c D(aeskey, nonce) -> giáº£i mÃ£ Ä‘Æ°á»£c Ä‘oáº¡n mÃ£ hÃ³a.

<a name="wu3"></a>  
ğŸ‘ŠğŸ‘†ğŸ¤²
# [RE] years 3000    

BÃ i nÃ y giá»‘ng bÃ i Defcon CTF 2017 Sorcery mÃ¬nh Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ [Ä‘Ã¢y](https://hacmao.pw/2020-02-01-Reversing_angr/)   
DÃ¹ng angr Ä‘á»ƒ explore path xong capstone Ä‘á»ƒ Ä‘á»c cÃ¢u lá»‡nh assemble, tá»« Ä‘Ã³ tÃ¬m kiáº¿m thÃ´ng tin thÃ´i.     
BÃ i nÃ y cÃ³ cÃ¡ch khÃ¡c lÃ  Ä‘á»c file, vÃ¬ vá»‹ trÃ­ cá»§a cÃ¡c kÃ­ tá»± cáº§n tÃ¬m á»Ÿ vá»‹ trÃ­ xÃ¡c Ä‘á»‹nh :)))   

<a name="wu4"></a>  
ğŸ‘ŠğŸ‘†ğŸ¤²
# [PWN] kid     
BÃ i nÃ y mÃ¬nh khÃ´ng lÃ m ra trong thá»i gian thi vÃ¬ má»™t sá»‘ lá»—i vá»› váº©n. ___*( ï¿£çš¿ï¿£)/#____    
Checksec ta cÃ³ :   
![](/ctf/2020/nullcon/kid/hinh2.PNG)     

ChÆ°Æ¡ng trÃ¬nh chá»‰ cÃ³ má»™t hÃ m main Ä‘Æ¡n giáº£n :   

![](/ctf/2020/nullcon/kid/hinh1.PNG)    

ChÆ°Æ¡ng trÃ¬nh nÃ y cho phÃ©p chÃºng ta láº§n Ä‘áº§u thá»±c hiá»‡n sáº½ Ä‘Æ°á»£c phÃ©p nháº­p sá»‘ liá»‡u vÃ o ```v7``` tá»« Ä‘Ã³ thay Ä‘á»•i thanh ghi ```rsp``` -> lá»—i buffer overflow. Cáº§n thá»±c nghiá»‡m vÃ i láº§n thÃ¬ sáº½ tÃ¬m ra Ä‘Æ°á»£c sá»‘ cáº§n nháº­p Ä‘á»ƒ Ä‘áº¡t yÃªu cáº§u.  
MÃ¬nh thá»­ nghiá»‡m thÃ¬ nháº­p giÃ¡ trá»‹ : ```1 << 63 + 0x280``` thÃ¬ Ä‘Æ°á»£c esp má»›i cÃ¡ch Ä‘á»‹a chá»‰ trá»Ÿ vá» cá»§a hÃ m main lÃ  ```136``` kÃ­ tá»±. ChÃºng ta Ä‘Æ°á»£c quyá»n nháº­p ```dx = 0x280``` kÃ­ tá»±. Äá»§ Ä‘á»ƒ trÃ n tá»›i Ä‘á»‹a chá»‰ trá»Ÿ vá».    
ğŸ˜¥ Báº±ng má»™t cÃ¡ch magic nÃ o Ä‘Ã³ mÃ  khi táº¯t ```ASLR``` thÃ¬ hÃ m Ä‘á»c sáº½ khÃ´ng Ä‘á»c Ä‘á»§ kÃ­ tá»±.Máº·c dÃ¹ mÃ¬nh debug tháº¥y ```edx = 0xffff``` mÃ  nÃ³ váº«n khÃ´ng Ä‘á»c kÃ­ tá»± nÃ o. CÅ©ng vÃ¬ váº­y mÃ  lÃºc Ä‘áº§u mÃ¬nh tá»‘n khÃ¡ nhiá»u thá»i gian táº¡i Ä‘Ã¢y khi má»i thá»© hoáº¡t Ä‘á»™ng khÃ´ng nhÆ° mong muá»‘n.    

ğŸ˜…ğŸ˜…ğŸ˜… MÃ¬nh nháº­n ra lá»—i nÃ y Ä‘áº§u tiÃªn. MÃ£i vá» sau má»›i phÃ¡t hiá»‡n ra má»™t lá»—i cÆ¡ báº£n khÃ¡c lÃ  ```format string```.   
### Step 1 : Leak information    
Táº­n dá»¥ng lá»—i format string, mÃ¬nh dÃ¹ng ```%30$p``` thÃ¬ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a ```0x750```. Trá»« Ä‘i ta cÃ³ Ä‘á»‹a chá»‰ ```PIE```.    
CÅ©ng cÃ³ thá»ƒ leak Ä‘á»‹a chá»‰ LIBC thÃ´ng qua lá»—i formatstring nhÆ°ng vÃ¬ mÃ¬nh phÃ¡t hiá»‡n lá»—i trÃ n trÆ°á»›c nÃªn lÃ  mÃ¬nh leak libc theo kiá»ƒu : trÃ n tá»›i 2 bytes cuá»‘i cá»§a Ä‘á»‹a chá»‰ trá»Ÿ vá» cá»§a hÃ m main, khi in nÃ³ sáº½ in luÃ´n ra Ä‘á»‹a chá»‰ trá»Ÿ vá».   

### Step 2 : Ret2main    
ChÃºng ta thá»±c hiá»‡n trÃ n trÆ°á»›c khi biáº¿t Ä‘Æ°á»£c Ä‘á»‹a chá»‰ trá»Ÿ vá». Cho nÃªn khÃ´ng thá»ƒ trÃ n vá» main ngÃ y Ä‘Æ°á»£c.    
Äá»‹a chá»‰ trá»Ÿ vá» cá»§a hÃ m main ban Ä‘áº§u lÃ  :  ```__libc_start_main```. HÃ m nÃ y Ä‘Æ°á»£c gá»i á»Ÿ start.    
```c
0x00007f08acbdfb84 <+212>:	mov    rsi,QWORD PTR [rsp+0x8]
0x00007f08acbdfb89 <+217>:	mov    edi,DWORD PTR [rsp+0x14]
0x00007f08acbdfb8d <+221>:	mov    rdx,QWORD PTR [rax]
0x00007f08acbdfb90 <+224>:	mov    rax,QWORD PTR [rsp+0x18]
0x00007f08acbdfb95 <+229>:	call   rax         // call main 
```  
Do chÆ°a biáº¿t Ä‘á»‹a chá»‰ cá»§a hÃ m nÃ o nÃªn chá»‰ cÃ³ thá»ƒ sá»­a 2 byte cuá»‘i cá»§a ```__libc_start_main``` thÃ´i. (ta Ä‘Ã£ biáº¿t 3 bytes, bruteforce 1 bytes).   
Khi debug, táº­n dá»¥ng stack mÃ¬nh tháº¥y náº¿u gá»i ```__libc_start_main + 224```, thÃ¬ ```rax = main```. Tá»©c chÃºng ta cÃ³ thá»ƒ trá»Ÿ vá» hÃ m main báº±ng cÃ¡ch nÃ y. :))) NÃ³ luÃ´n luÃ´n hoáº¡t Ä‘á»™ng vÃ¬ hÃ m start lÃºc báº¯t Ä‘áº§u cÃ³ ```push main```.    

### Step 3 :  Overwrite exit   
Do Sau khi trá»Ÿ láº¡i main láº§n 2, ```unk_20105C = 1``` nÃªn nÃ³ sáº½ vÃ o in ra ```JK, You lose``` rá»“i ```exit``` mÃ  khÃ´ng thá»±c hiá»‡n ```ret2main```.  
Äiá»u nÃ y khÃ¡ Ä‘Æ¡n giáº£n vÃ¬ chÃºng ta Ä‘Ã£ cÃ³ lá»—i format string Ä‘á»ƒ ghi Ä‘Ã¨.   
(* ï¿£ï¸¿ï¿£)ÄÃ³ lÃ  mÃ¬nh nghÄ© tháº¿ cÃ²n khi viáº¿t script thÃ¬ cháº­t váº­t mÃ£i má»›i xong. MÃ¬nh cÃ³ viáº¿t Ä‘Æ°á»£c má»™t hÃ m automatic gen formatstring write , lÆ°u láº¡i sau dÃ¹ng dáº§n :     

```python 
def format_write(addr, number) : 

    payload = '' 
    old_c = 0 
    value = []
    for i in range(8) : 
        value.append((number >> (i * 8)) % 256)
        
    for i in range(len(value)) : 
        new_c = value[i]  
        if new_c > old_c : 
            res = new_c - old_c 
        else : 
            res = 256 + new_c - old_c
        old_c = new_c 
        payload += '%' + str(res) + 'c' + '%' + '{}$hhn'
        
    payload += '0' * (8 - len(payload) % 8)
    offset = len(payload) / 8 + 6
    payload = payload.format(*[offset + i for i in range(len(value))] )
    for i in range(8) : 
        payload += p64(addr + i)
    return payload 
    
```     
MÃ¬nh Ä‘Ã£ thá»­ overwrite ```exit``` báº±ng ```one_gadget``` nhÆ°ng khÃ´ng thÃ nh cÃ´ng.ÄÃ nh overwrite thÃ nh ```main``` xong chuyá»ƒn ```printf``` thÃ nh hÃ m ```system``` gá»i ```/bin/sh\x00``` thÃ´i :)))   done    

![](/ctf/2020/nullcon/kid/hinh3.PNG)    

ğŸ‡ğŸ‡ğŸ‡ Äá»c writeup : https://github.com/kam1tsur3/2020_CTF/blob/master/nullcon/pwn/KiDPwN/README.md thÃ¬ tháº§y ngÆ°á»i ta dÃ¹ng ROP.Cá»¥ thá»ƒ lÃ  dÃ¹ng ```3pop; ret``` thÃ¬ cÅ©ng Ä‘áº¡t hiá»‡u quáº£ tÆ°Æ¡ng tá»±. CÃ¡ch  suy nghÄ© nÃ y hay hÆ¡n vÃ¬ khÃ´ng phá»¥c thuá»™c vÃ o hÃ m ```__libc_start_main``` mÃ  hÃ m nÃ y láº¡i thay Ä‘á»•i theo tá»«ng phiÃªn báº£n libc nÃªn khÃ³ Ä‘á»ƒ cÃ¢n báº±ng trÃªn server. Äá»“ng thá»i, lÃºc Ä‘Ã³ láº¡i dÃ¹ng ```one_gadget``` Ä‘Æ°á»£c :v Äá»c má»›i tháº¥y cÃ¡ch cá»§a ngÆ°á»i ta tá»‘i Æ°u vl (ã£ Â°Ğ” Â°;)ã£    

<a name="wu4"></a>  
ğŸ‘ŠğŸ‘†ğŸ¤²
# Dark Honya     
Link writeup : https://teamrocketist.github.io/2020/02/09/Pwn-Nullcon-2020-DarkHonya/   
MÃ¬nh Ä‘á»c nhiá»u bÃ i writeup cá»§a nhÃ³m nÃ y viáº¿t ráº¥t hay, dá»… hiá»ƒu. BÃ i nÃ y lÃ  má»™t bÃ i heap sá»­ dá»¥ng kÄ© thuáº­t unlink + null-byte overflow.  
 + null-byte overflow : ghi Ä‘Ã¨ lÃªn táº¡o fake free chunk -> unlink   
 + unlink : ghi Ä‘Ã¨ lÃªn ptr[0] = ptr[0] - 0x18    
Thá»±c ra Ä‘Ã¢y lÃ  unsafe unlink Ä‘Æ°á»£c trÃ¬nh bÃ y bá»Ÿi shellfish : https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c
Tá»« Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ ghi Ä‘Ã¨ lÃªn GOT -> thá»±c hiá»‡n leak libc báº±ng lá»—i format string -> get shell.    

