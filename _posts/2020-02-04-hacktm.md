---
layout : post
title : Hacktm CTF 2020    
---   


# HackTm 2019    
  - 4 solved :     
     ğŸ‘‰ RSA1    
     ğŸ‘‰ RSA2    
     ğŸ‘‰ Prision break    
     ğŸ‘‰ [**Baby bear**](#wu1)     
  - unsolved : many :))) but read writeup so listed here   
     ğŸ‘‰ [**Obey_the_rules**](#wu2)   
     ğŸ‘‰ [**Strange PCAP**](#wu3)  

<a name="wu1"></a>     

# Baby bear     
ÄÃ¢y lÃ  má»™t file bá»‹ pack bá»Ÿi UPX nhÆ°ng Ä‘Ã£ bá»‹ sá»­a :vv   ğŸ˜…ğŸ˜…ğŸ˜… NhÆ°ng magic lÃ  váº«n Ä‘á»c Ä‘Æ°á»£c Ä‘áº§y Ä‘á»§ code vÃ¬ nÃ³ Ä‘Æ°á»£c compile tá»« assembly. Váº«n cÃ³ nhá»¯ng string cÃ¹ng vá»›i má»™t sá»‘ hÃ m cÆ¡ báº£n nÃªn viá»‡c reverse mÃ  khÃ´ng cáº§n unpack lÃ  Ä‘iá»ƒu kháº£ thi.    
![](/ctf/2020/hacktm/baby_bear/hinh1.PNG)    

HÃ m ```start``` :    

![](/ctf/2020/hacktm/baby_bear/hinh2.PNG)    

HÃ m start báº¯t Ä‘áº§u báº±ng viá»‡c Ä‘á»c 16 bytes tá»« file /dev/urandom lÃ m giÃ¡ trá»‹ khá»Ÿi táº¡o, chuyá»ƒn nÃ³ vá» dáº¡ng bit theo kiá»ƒu 'a' -> '10000110' rá»“i in hÃ¬nh con gáº¥u.   Sau Ä‘Ã³, lÃ  Ä‘áº¿n Ä‘oáº¡n mÃ£ hÃ³a string :    

![](/ctf/2020/hacktm/baby_bear/hinh3.PNG)    

Do Ä‘ang bá»‹ pack nÃªn trÃ´ng khÃ´ng ra hÃ m nhÆ°ng ta cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c hÃ m mÃ£ hÃ³a nÃ y cÃ³ hai tham sá»‘ truyá»n vÃ o lÃ  Ä‘á»™ dÃ i Ä‘oáº¡n mÃ£ hÃ³a Ä‘áº§u ra lÃ  46 vÃ  Ä‘á»‹a chá»‰ lÆ°u giá»¯ string lÃ  ```esi = 0x600780```.   
   
Ban Ä‘áº§u , mÃ¬nh dÃ¹ng unicorn Ä‘á»ƒ dá»±ng láº¡i hÃ m mÃ£ hÃ³a nÃ y, cho má»™t input Ä‘áº§u vÃ o vÃ  cÃ³ Ä‘Æ°á»£c output Ä‘áº§u ra. Viá»‡c thiáº¿t láº­p unicorn theo cÃ¡c bÆ°á»›c khÃ´ng quÃ¡ phá»©c táº¡p : [basic setup](https://www.notion.so/Basic-Setup-179a2615e2a7472d8083423f05126bf8) vÃ  [execute binary function](https://www.notion.so/Execute-Binary-Function-08884ed07d9b44519c44963fb641b35e) . ğŸ˜ğŸ˜ğŸ˜Sau khi chÆ¡i vá»›i input ngáº«u nhiÃªn vÃ  xem output Ä‘áº§u ra lÃ  gÃ¬, mÃ¬nh rÃºt ra Ä‘Æ°á»£c nháº­n xÃ©t lÃ  cá»© 2 bytes Ä‘áº§u thÃ¬ output Ä‘áº§u ra giá»‘ng nhau Ã­t nháº¥t lÃ  8 bits, 3 bytes thÃ¬ lÃ  11 bits, .... (ï½oï¿£3ï¿£)ï½ BÃ™m mÃ¬nh Ä‘á»‹nh brute force tá»« Ä‘Ã¢y. NhÆ°ng cÃ³ quÃ¡ nhiá»u trÆ°á»ng há»£p vÃ  thá»i gian bruteforce cÃ³ thá»ƒ lÃªn tá»›i Ä‘Æ¡n vá»‹ tiáº¿ng mÃ  timeout cá»§a server chá»‰ lÃ  30s ğŸ™„ğŸ™„ğŸ™„ Vá»›i trÃ¬nh Ä‘á»™ má»›i táº­p chÆ¡i unicorn thÃ¬ mÃ¬nh cÅ©ng khÃ¡ lÃ  gÃ  trong viá»‡c viáº¿t script nÃ y ğŸ˜¥ğŸ˜¥ğŸ˜¥    
Sau khi Ä‘á»c láº¡i code vÃ  cá»‘ viáº¿t láº¡i graph cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a chÆ°Æ¡ng trÃ¬nh thÃ¬ mÃ¬nh cÅ©ng hiá»ƒu sÆ¡ sÆ¡ nhÆ°ng nÃ³ khÃ¡ lÃ  phá»©c táº¡p nÃªn mÃ¬nh chá»‰ Ä‘á»c Ä‘oáº¡n Ä‘áº§u. KhÃ´ng ngá» cÃ³ team ngá»“i reverse háº¿t Ä‘Æ°á»£c :))) ChÆ°Æ¡ng trÃ¬nh há» viáº¿t láº¡i Ä‘Æ°á»£c thÃ¬ trÃ´ng nÃ³ nhÆ° nÃ y :)))   

![](/ctf/2020/hacktm/baby_bear/hinh4.PNG)    

Trá»Ÿ láº¡i quÃ¡ trÃ¬nh mÃ£ hÃ³a, trong má»—i láº§n láº·p, nÃ³ sáº½ tÄƒng esi lÃªn tá»« 1 - 3 Ä‘Æ¡n vá»‹ , khÃ´ng thá»ƒ giáº£m vÃ  cho ra má»™t giÃ¡ trá»‹ output, in ra mÃ n hÃ¬nh báº±ng hÃ m ```sub_4000B0```. Output Ä‘áº§u ra cÃ³ thá»ƒ láº¥y tá»« chuá»—i truyá»n vÃ o hoáº·c khÃ´ng, do Ä‘Ã³ input mÃ  ta tÃ¬m Ä‘Æ°á»£c cÃ³ thá»ƒ khÃ´ng giá»‘ng vá»›i input ban Ä‘áº§u. VÃ  nháº£y tá»›i block mÃ£ hÃ³a tiáº¿p theo. CÃ³ táº¥t cáº£ 9 block mÃ£ hÃ³a mÃ¬nh Ä‘Ã¡nh dáº¥u Ä‘Æ°á»£c báº±ng hÃ m ```sub_4000B0``` - hÃ m set vÃ  ghi giÃ¡ trá»‹ output. Má»—i block sáº½ set má»™t giÃ¡ trá»‹ output xÃ¡c Ä‘á»‹nh. 
```
return_value = {0x40010B: 1, 
                    0x400348: 1, 
                    0x400374: 0,
                    0x4003A5: 0,
                    0x4003B6: 0, 
                    0x4003CF: 0, 
                    0x400417: 1,
                    0x400463: 0, 
                    0x40047D: 1 
    } 
```    
Do viá»‡c quyáº¿t Ä‘á»‹nh bit Ä‘áº§u ra lÃ  kiá»ƒu logic mÃ  khÃ´ng pháº£i phÃ©p toÃ¡n sá»‘ há»c nÃªn gÃ¢y khÃ³ khÄƒn cho ngÆ°á»i chÆ¡i.       

Äáº¿n Ä‘Ã¢y, thÃ¬ do táº¡i má»—i bÆ°á»›c cÃ³ hai lá»±a chá»n lÃ  '0' hoáº·c '1', giá»‘ng há»‡t nhÆ° má»™t cÃ¢y nhá»‹ phÃ¢n. . Cá»© Ä‘i theo cÃ¢y nhá»‹ phÃ¢n, biáº¿t vá»‹ trÃ­ hiá»‡n táº¡i trong cÃ¢y, vÃ  vá»‹ trÃ¬ tiáº¿p theo thÃ¬ hoÃ n toÃ n cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c nhÃ¡nh nÃ o lÃ  nhÃ¡nh cáº§n tÃ¬m vÃ  giÃ¡ trá»‹ bit nÃ o thá»a mÃ£n Ä‘i theo nhÃ¡nh Ä‘Ã³. Viá»‡c tá»± Ä‘á»™ng hÃ³a quÃ¡ trÃ¬nh nÃ y thÃ¬ hÆ¡i phá»©c táº¡p hÆ¡n tÃ­. Giá» láº¡i nhá»› láº¡i há»“i há»c thuáº­t toÃ¡n, sao mÃ¬nh khÃ´ng chÄƒm chá»‰ hÆ¡n Ä‘á»ƒ giá» ngá»“i viáº¿t code má»‡t tháº¿ nÃ y ğŸ¤£ğŸ¤£ğŸ¤£ Ã€ nhÆ°ng sau má»™t há»“i viáº¿t thÃ¬ nÃ³ cÅ©ng khÃ´ng quÃ¡ phá»©c táº¡p nhÆ° mÃ¬nh tÆ°á»Ÿng tÆ°á»£ng.   

CÃ¡c bÆ°á»›c sáº½ nhÆ° sau :    
### BÆ°á»›c 1 : Báº¯t Ä‘áº§u tá»« string rá»—ng, current_esi = 0x600780     
```current_esi``` lÃ  giÃ¡ trá»‹ thanh ghi esi mÃ  á»Ÿ Ä‘Ã³ ta thu Ä‘Æ°á»£c k bit cá»§a chuá»—i ouput cáº§n Ä‘áº¡t Ä‘Æ°á»£c    
### BÆ°á»›c 2 : Brute force tá»«ng bit cá»§a target output        
Do má»—i bÆ°á»›c Ä‘i thanh ghi esi chá»‰ tÄƒng 1-3 bit mÃ  khÃ´ng giáº£m nÃªn táº¡i má»—i bÆ°á»›c ta bruteforce 3 bit nÃ y. DÃ¹ng unicorn Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem khi nÃ o thanh ghi esi vÆ°á»£t quÃ¡ giÃ¡ trá»‹ ```current_esi```,Ä‘Ã³ lÃ  thá»i Ä‘iá»ƒm mÃ  chÆ°Æ¡ng trÃ¬nh sáº½ set output tiáº¿p theo. Tiáº¿p tá»¥c trace thÃªm vÃ i lá»‡nh ná»¯a, táº¡i thá»i Ä‘iá»ƒm chÆ°Æ¡ng trÃ¬nh gá»i hÃ m ```sub_4000B0```. ÄÃ¢y lÃ  thá»i Ä‘iá»ƒm chÆ°Æ¡ng trÃ¬nh set bit output tiáº¿p theo mÃ  chÃºng ta Ä‘ang bruteforce. Kiá»ƒm tra bit sáº½ Ä‘Æ°á»£c set dá»±a trÃªn list return value trÃªn kia, náº¿u Ä‘Ãºng thÃ¬ dá»«ng :    

```python
if bytes_to_long(machine_code[1:][::-1]) + address - 0x4000B0 == 0xfffffffb :  # if call sub_4000B0
    rsi = mu.reg_read(UC_X86_REG_RSI)
    if rsi > old_rsi  :  # if we just pass old position 
        if return_value[address] == int(target_bits) :    # come to function set true target bits  
```  

Kiá»ƒm tra giÃ¡ trá»‹ thanh ghi rsi, Ä‘Ã³ lÃ  Ä‘á»™ dÃ i chuá»—i bit input áº£nh hÆ°á»Ÿng tá»›i output hiá»‡n táº¡i, do Ä‘Ã³ ta láº¥y Ä‘Ãºng sá»‘ lÆ°á»£ng bits Ä‘Ã£ Ä‘Ã³ thÃ nh input Ä‘áº§u vÃ o.   
```python
# print("[***] RSI = " + hex(rsi)) 
raw_input = payload[:rsi - 0x600780]    # rsi - 0x600780 is the number byte effect to this state
old_rsi = rsi  
found = True 
```
### BÆ°á»›c 3 : Tiáº¿p tá»¥c bruteforce tá»«ng bits nhÆ° tháº¿ cho tá»›i khi thu Ä‘Æ°á»£c káº¿t quáº£ cuá»‘i cÃ¹ng 

 

# Obey The Rules   <a name="wu2"></a>

Link writeup : https://blog.redrocket.club/2020/02/04/hacktm20-obeytherules/    
Qua bÃ i nÃ y mÃ¬nh há»c thÃªm Ä‘Æ°á»£c má»™t chÃºt vá» shellcode.  
File nÃ y cho phÃ©p chÃºng ta thá»±c hiá»‡n shellcode : 
```python
payload = "Y\0" + shellcode    
```   
Gáº·p shellcode lÃ  ngáº¡i rá»“i vÃ¬ chÆ°a luyá»‡n nhiá»u. Láº¡i cÃ²n dÃ­nh seccomp Â§(*ï¿£â–½ï¿£*)Â§ Láº§n Ä‘áº§u nghe Ä‘Æ°á»£c.   
Thá»±c ra seccomp cÅ©ng chá»‰ lÃ  nhá»¯ng rules giá»›i háº¡n cÃ¡c lá»‡nh gá»i system call thÃ´i. Trong bÃ i nÃ y rules bá»‹ áº©n Ä‘i, ta cÃ³ thá»ƒ check nhá»¯ng seccomp gÃ¬ dÃ¹ng Ä‘Æ°á»£c báº±ng cÃ¡ch :   
```python   
shellcode = """
  xor rax, rax;
  mov al, {};
  syscall;
  ud2;   # crash program   
"""
``` 
Náº¿u rule Ä‘Æ°á»£c thÃ´ng qua thÃ¬ chÆ°Æ¡ng trÃ¬nh tráº£ vá» ```illegal instruction``` cÃ²n khÃ´ng sáº½ tráº£ vá» ```segmentation fault```. RiÃªng system call ```0``` khÃ´ng check Ä‘Æ°á»£c báº±ng shellcode trÃªn do ```strcpy``` khÃ´ng copy byte null. Syscall ```60 (exit)``` thÃ¬ khÃ´ng tráº£ vá» gÃ¬ náº¿u thÃ nh cÃ´ng do chÆ°Æ¡ng trÃ¬nh tá»± Ä‘á»™ng káº¿t thÃºc.     
Tiáº¿p Ä‘áº¿n, tiáº¿n hÃ nh Ä‘á»ƒ má»Ÿ rá»™ng Ä‘á»™ lá»›n cá»§a shellcode báº±ng cÃ¡ch ```read(0, &$rip, 0x1234)```. Viáº¿t tiáº¿p shellcode.   
```python
shellcode = """
  push rbx;
  push rbx;
  pop rax;
  pop rdi;
  pop rsi;
  mov dh, 0xff; 
  syscall;
"""
```
LÆ°u Ã½ : 
 + chÃº Ã½ giÃ¡ trá»‹ khá»Ÿi táº¡o trÆ°á»›c khi thá»±c thi shellcode Ä‘á»ƒ lÃ m giáº£m Ä‘á»™ dÃ i cá»§a shellcode, trong trÆ°á»ng há»£p nÃ y do rbx = 0 nÃªn ta cÃ³ thá»ƒ dÃ¹ng cáº·p lá»‡nh ```push-pop``` Ä‘á»ƒ set ```rax=rdi=0``` tá»‘n Ã­t bytes hÆ¡n.
 + Ä‘á»‰nh stack lÆ°u trá»¯ giÃ¡ trá»‹ ráº¥t gáº§n vá»›i Ä‘á»‹a chá»‰ thanh ghi $rip hiá»‡n táº¡i, lÃ  cÃ¢u lá»‡nh phÃ­a sau syscall, thá»±c táº¿ nÃ³ chá»‰ vÃ o Ä‘áº§u cá»§a shellode cho nÃªn ta cÃ³ thá»ƒ dÃ¹ng lá»‡nh ```pop rsi``` Ä‘á»ƒ chá»‰ Ä‘á»‹nh buffer .   

ğŸ‘‰ Cuá»‘i cÃ¹ng tiáº¿n hÃ nh timming attack :  
```
Má»Ÿ file 
-> Äá»c flag 
-> So sÃ¡nh vá»›i giÃ¡ trá»‹ bruteforce
-> ÄÃºng thÃ¬ láº·p vÃ´ háº¡n 
-> Sai thÃ¬ dá»«ng 
```  
NhÆ° váº­y, dá»±a vÃ o thá»i gian thá»±c hiá»‡n ta cÃ³ thá»ƒ biáº¿t Ä‘Æ°á»£c byte nÃ o Ä‘Ãºng, byte nÃ o sai.   
ChÃºng ta cÃ³ thá»ƒ viáº¿t nhanh Ä‘oáº¡n shellcode trÃªn báº±ng ```shellcraft```.  
Shellcraft note :    
 + Open : shellcraft.open(filename) 
 + Read : shellcraft.read(fd="fd-name", buffer="buffer-name", count=0x1234) 
 + Exit : shellcraft.exit(0)   


# Strange PCAP <a name="wu3"></a>   
Link writeup : https://blog.b00t.nl/Strange-PCAP/
BÃ i nÃ y cho má»™t file pcap. Sau khi phÃ¢n tÃ­ch thÃ¬ tÃ¬m ra Ä‘Æ°á»£c má»™t file zip. Pháº§n tÃ¬m ra file zip thÃ¬ cÃ³ thá»ƒ báº±ng cÃ¡ch fitler Ä‘á»™ dÃ i frame : 
```
frame.len > 100 
```
Äiá»ƒm mÃ¬nh tháº¥y há»©ng thÃº á»Ÿ bÃ i nÃ y lÃ  cÃ¡ch lá»c USB keyboard, xÆ°a cÅ©ng gáº·p bÃ i tÆ°Æ¡ng tá»± má»™t láº§n rá»“i mÃ  mÃ¬nh khÃ´ng cÃ³ Ä‘á»c writeup (â—'â—¡'â—).  

### USB Filter :  

```
tshark -r filename -T fields -e usb.capdata | sed '/^\s*$/d' > output
```
Bá» nhá»¯ng dÃ²ng khÃ´ng Ä‘Ãºng Ä‘á»™ dÃ i Ä‘i .   

### Convert to string 
```python
usb_codes = {
   0x04:"aA", 0x05:"bB", 0x06:"cC", 0x07:"dD", 0x08:"eE", 0x09:"fF",
   0x0A:"gG", 0x0B:"hH", 0x0C:"iI", 0x0D:"jJ", 0x0E:"kK", 0x0F:"lL",
   0x10:"mM", 0x11:"nN", 0x12:"oO", 0x13:"pP", 0x14:"qQ", 0x15:"rR",
   0x16:"sS", 0x17:"tT", 0x18:"uU", 0x19:"vV", 0x1A:"wW", 0x1B:"xX",
   0x1C:"yY", 0x1D:"zZ", 0x1E:"1!", 0x1F:"2@", 0x20:"3#", 0x21:"4$",
   0x22:"5%", 0x23:"6^", 0x24:"7&", 0x25:"8*", 0x26:"9(", 0x27:"0)",
   0x2C:"  ", 0x2D:"-_", 0x2E:"=+", 0x2F:"[{", 0x30:"]}",  0x32:"#~",
   0x33:";:", 0x34:"'\"",  0x36:",<",  0x37:".>", 0x4f:">", 0x50:"<"
   }
buff = ""

pos = 0
for x in open("output","r").readlines():
    code = int(x[4:6],16)

    if code == 0:
        continue
    if code == 0x28:
        buff += "[ENTER]"
        continue
    if int(x[0:2],16) == 2 or int(x[0:2],16) == 0x20:
        buff += usb_codes[code][1]
    else:
        buff += usb_codes[code][0]
```
CÅ©ng khÃ´ng quÃ¡ phá»©c táº¡p.    


à¼¼ ã¤ â—•_â—• à¼½ã¤ To be continued   

