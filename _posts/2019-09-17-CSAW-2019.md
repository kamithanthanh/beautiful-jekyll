---
layout : post 
title : CSAW 2019 
--- 

# Table Contents 

  - [[Pwn] Popping caps](#wu1)   
  - [[Crypto] SuperCurve](#wu2)
  - [[Crypto] FaultBox](#wu3)  
  
<a name="wu1">  
</a>  


# [PWN] Popping caps  

![](/Pwnable/ctf/csaw/jojo.jpeg)  

Ohhh! Here we go again!  

Láº¡i lÃ  writeup cá»§a team [nÃ y](https://teamrocketist.github.io/2019/09/16/Pwn-csaw-2019-popping-caps/). Writeup ráº¥t chi tiáº¿t láº¡i cháº¥t lÆ°á»£ng vl. Qua Ä‘Ã¢y mÃ¬nh há»c thÃªm kiáº¿n thá»©c vá» [**tcache_perthread_struct**](https://github.com/lunaczp/glibc-2.27/blob/master/malloc/malloc.c#L2914) cÃ¹ng vá»›i ```[tcache house of spirit]```.  

![](/Pwnable/ctf/csaw/hinh1.PNG)  

Sau khi free má»™t chunk cÃ³ size < 0x410 thÃ¬ nÃ³ sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o tcache bins. Tcachebins trong GDB sáº½ cÃ³ dáº¡ng nhÆ° trÃªn. Linked list , size vÃ  sá»‘ chunk trong linked list Ä‘Æ°á»£c mÃ´ táº£ trong **tcache_perthread_struct**.  

```c
typedef struct tcache_entry
{
  struct tcache_entry *next;
} tcache_entry;

typedef struct tcache_perthread_struct
{
  char counts[TCACHE_MAX_BINS]; 
  tcache_entry *entries[TCACHE_MAX_BINS];
} tcache_perthread_struct;

static __thread bool tcache_shutting_down = false;
static __thread tcache_perthread_struct *tcache = NULL;
```  

Trong Ä‘Ã³ entries lÃ  lÆ°u giá»¯ node Ä‘áº§u cá»§a linked list á»©ng vá»›i má»—i size (0x10, 0x20, 0x30, ...). CÃ²n counts lÆ°u giá»¯ sá»‘ chunk trong 1 linked list tÆ°Æ¡ng á»©ng vá»›i tá»«ng size. ```TCACHE_MAX_BINS = 64``` vÃ  má»—i size cÃ³ max lÃ  7 tcachebins.  

OK trá»Ÿ láº¡i vá»›i bÃ i nÃ y. ChÆ°Æ¡ng trÃ¬nh cÃ³ 3 chá»©c nÄƒng cÆ¡ báº£n ```malloc```, ```free```, ```write``` .  

![](/Pwnable/ctf/csaw/hinh2.PNG)  

![](/Pwnable/ctf/csaw/hinh3.PNG)   

ChÃºng ta cÃ³ lá»—i double free vÃ¬ con trá» khÃ´ng Ä‘Æ°á»£c reset sau khi free. Äá»“ng thá»i chÃºng ta cÃ³ lá»—i ```out of bound``` Ä‘á»ƒ cÃ³ thá»ƒ free báº¥t cá»© chunk nÃ o trong heap. LÃºc Ä‘áº§u mÃ¬nh khÃ´ng Ä‘á»c kÄ© láº¡i nghÄ© lÃ  free báº¥t cá»© chunk nÃ o trong stack cÆ¡ ğŸ˜†ğŸ˜†ğŸ˜† Lá»—i nÃ y giÃºp ta nghÄ© tá»›i ```house of spirit```.  
Äáº§u tiÃªn hÆ°á»›ng tiáº¿p cáº­n Ä‘Æ¡n giáº£n sáº½ lÃ  ```tcache dupinto stack``` cÆ¡ mÃ  do nÃ³ filter sá»‘ láº§n thá»±c hiá»‡n cÃ³ 7 láº§n mÃ  phÆ°Æ¡ng phÃ¡p nÃ y cáº§n Ã­t nháº¥t 8 láº§n Ä‘á»ƒ thá»±c hiá»‡n. ğŸ˜±ğŸ˜±ğŸ˜± Every things are not so simple like that.  

Cho nÃªn chÃºng ta cáº§n nghÄ© cÃ¡ch rÃºt ngáº¯n sá»‘ lÆ°á»£ng malloc Ä‘i. BÃ i nÃ y cÅ©ng cho sáºµn chÃºng ta Ä‘á»‹a chá»‰ hÃ m ```system``` rá»“i nÃªn cÃ³ thá»ƒ thá»±c hiá»‡n ghi Ä‘Ã¨ lÃªn ```__malloc_hook``` Ä‘á»‹a chá»‰ cá»§a gadget nÃ o Ä‘Ã³.  

## STAGE 1 : Create fake chunk on tcach_perthread_struct   

Äáº§u tiÃªn thá»­ malloc 1 vÃ¹ng nhá»› size 0x40 :  

![](/Pwnable/ctf/csaw/hinh4.PNG)  

Ta dÃ¹ng GDB Ä‘á»ƒ xem **tcache_perthread_struct**. Ta tháº¥y ```0x557b2d5dc013 = 0x1``` lÃ  sá»‘ chunk tÆ°Æ¡ng á»©ng vá»›i size 0x50. Äá»ƒ táº¡o Ä‘Æ°á»£c fake chunk dÃ¹ng cho ```house_of_spirit``` thÃ¬ pháº§n size cá»§a chunk pháº£i Ä‘Æ°á»£c set tá»›i 1 sá»‘ thÃ­ch há»£p.  
 ğŸŒ Solution :  Malloc(0x3a8) -> Free.  

ThÃ¬ pháº§n count tÆ°Æ¡ng á»©ng vá»›i size 0x3b0 sáº½ Ä‘Æ°á»£c set. Táº¡o thÃ nh fake size cho target cá»§a chÃºng ta. LÃ  size ```0x100```.

![](/Pwnable/ctf/csaw/hinh5.PNG)   

## STAGE 2 : House of spirits to tcache_perthread_struct -> entries  

Sau khi fake Ä‘Æ°á»£c size thÃ¬ chÃºng ta tiáº¿n hÃ nh tÃ­nh toÃ¡n Ä‘á»‹a chá»‰ rá»“i free fake chunk. ChÃºng ta Ä‘Æ°a Ä‘Æ°á»£c chunk Ä‘Ã³ vÃ o tcachebins size  0x100. Sau Ä‘Ã³ malloc 1 láº§n ná»¯a lÃ  ta malloc Ä‘Æ°á»£c vÃ o vÃ¹ng **tcache_perthread_struct -> entries+2**.  

![](/Pwnable/ctf/csaw/hinh6.PNG)   

## STAGE 3 : Edit with malloc_hook  

Khi chÃºng ta cÃ³ quyá»n ghi vÃ o vÃ¹ng **tcache_perthread_struct -> entries + 2** thÃ¬ tá»©c lÃ  ta cÃ³ quyá»n thÃªm con trá» vÃ o cÃ¡c free single linked list. LÃºc nÃ y náº¿u chÃºng ta sá»­a dá»¯ liá»‡u vÃ¹ng nÃ y thÃ nh Ä‘á»‹a chá»‰ **malloc_hook** thÃ¬ trong láº§n malloc tiáº¿p theo vá»›i size tÆ°á»›ng á»©ng (0x20) ta sáº½ cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a **malloc_hook**.  LÃºc nÃ y thÃ¬ thoáº£i mÃ¡i ghi Ä‘á»‹a chá»‰ gadget vÃ  cÃ³ Ä‘Æ°á»£c shell thÃ´i.  

![](/Pwnable/ctf/csaw/hinh7.PNG)  

Táº¡i sao ta láº¡i cÃ³ size lÃ  0x20 ? ğŸ˜¬ğŸ˜¬ğŸ˜¬ VÃ¬ chÃºng ta ghi malloc_hook vÃ o pháº§n Ä‘áº§u tiÃªn cá»§a entries nÃªn nÃ³ tÆ°Æ¡ng á»©ng vá»›i size 0x20.  

<a name="wu2">  
</a>  

# [Crypto] SuperCurve  

ÄÃ¢y lÃ  má»™t bÃ i Elliptic curve. Nghe ECC lÃ  sá»£ vl rá»“i. LÃ¢u rá»“i mÃ¬nh khÃ´ng try hard crypto nÃªn dáº¡o nÃ y cáº£m tháº¥y trÃ¬nh cÃ¹i vl.  
Ok vÃ o bÃ i , ta cÃ³ má»™t hÃ m ```supercurve.py``` cÃ³ nhá»¯ng hÃ m cÆ¡ báº£n cá»§a ECC nhÆ° ```add```, ```mul```.  
Sau Ä‘Ã³ trong hÃ m ```server.py```, ta pháº£i submit giáº£i Ä‘Æ°á»£c DLP trong ECC :  

```python 
secret_scalar = random.randrange(curve.order)
  base = curve.g
  pub = curve.mult(secret_scalar, base)
  print("Public key: {}".format(pub))
  #print("Secret scalar: {}".format(secret_scalar))

  while True:
      print("What is the secret?")
      user_input = input("Asking for secret")
      user_input = int(user_input)

      if curve.mult(user_input, base) == pub:
          with open("flag.txt", "r") as f:
              print(f.read())
          break
      else:
          print("WRONGGG!")
          continue
``` 
Tuy nhiÃªn Ä‘iá»ƒm yáº¿u á»Ÿ Ä‘Ã¢y lÃ  nÃ³ láº¥y cÃ¡i ```secret_scalar``` nÃ³ láº¥y trong range ráº¥t nhá» ```7919```. NÃªn cÃ³ thá»ƒ dá»… dÃ ng bruteforce Ä‘á»ƒ tÃ¬m secret. Ez ECC.  

<a name="wu3">  
</a>  

# [Crypto] Fault Box  

ÄÃ¢y lÃ  má»™t bÃ i RSA khÃ¡ thÃº vá»‹. KhÃ´ng náº·ng vá» toÃ¡n há»c mÃ  thiÃªn vá» bruteforce.  
Äáº§u tiÃªn chÃºng ta cÃ³ hÃ m ```gen_prime``` :  
```python
def gen_prime():
    base = random.getrandbits(1024)
    off = 0 
    while True:
        if gmpy2.is_prime(base + off):
            break
        off += 1
    p = base + off

    return p, off
```  
HÃ m nÃ y nÃ³ dÃ¹ng hÃ m random cá»§a python Ä‘á»ƒ gen random. LÃ¢y seed lÃ  thá»i gian :  

```python
class incoming(socketserver.BaseRequestHandler):
    def handle(self):
        signal.alarm(300)
        random.seed(time.time())
```

HÃ m thá»i gian lÃ  má»™t sá»‘ thá»±c cÃ³ 7 chá»¯ sá»‘ tháº­p phÃ¢n. NÃªn ta cÃ³ thá»ƒ nghÄ© tá»›i chuyá»‡n bruteforce hÃ m nÃ y.  

ChÃºng ta cÃ³ 4 hÃ m encrypt  :  

```python
    p, x = gen_prime()
    q, y = gen_prime()

    r.generate(p, q)
    fake_flag = 'fake_flag{%s}' % (('%X' % y).rjust(32, '0'))

    def enc_flag():
        req.sendall(b'%X\n' % r.encrypt(s2n(FLAG)))

    def enc_fake_flag():
        req.sendall(b'%X\n' % r.encrypt(s2n(fake_flag)))
    def enc_fake_flag_TEST():
        req.sendall(b'%X\n' % r.TEST_CRT_encrypt(s2n(fake_flag), x))

    def enc_msg():
        req.sendall(b'input the data:')
        p = str(req.recv(4096).strip(), 'utf-8')
        req.sendall(b'%X\n' % r.encrypt(s2n(p)))
```

Má»™t hÃ m Ä‘Ãºng nhÆ° tÃªn gá»i cá»§a nÃ³, nÃ³ cho ra Ä‘á»ƒ Ä‘Ã¡nh láº¡c hÆ°á»›ng ngÆ°á»i chÆ¡i vá»›i nhá»¯ng kiáº¿n thá»©c sá»‘ há»c khÃ³ mÃ  break Ä‘Æ°á»£c.  
Äáº§u tiÃªn chÃºng ta pháº£i bruteforce y. Do y ráº¥t bÃ© nÃªn cÃ³ thá»ƒ bruteforce nhá» hÃ m enc_msg. ChÃºng ta táº¡o fake_flag rá»“i encrypt báº±ng hÃ m nÃ y. So sÃ¡nh vá»›i giÃ¡ trá»‹ thu Ä‘Æ°á»£c tá»« hÃ m ```enc_fake_flag``` thÃ¬ ta sáº½ brute Ä‘Æ°á»£c y.  
Sau Ä‘Ã³ láº¥y ```enc_flag```.  LÆ°u thá»i gian báº¯t Ä‘áº§u vÃ  thá»i gian káº¿t thÃºc khi nháº­n Ä‘Æ°á»£c ```enc_flag``` Ä‘á»ƒ bruteforce Ã­t hÆ¡n.  
BÆ°á»›c tiáº¿p theo lÃ  tiáº¿n hÃ nh bruteforce hÃ m thá»i gian. ChÃºng ta tiáº¿n hÃ n gen p, q rá»“i khi nÃ o thu Ä‘Æ°á»£c y nhÆ° ta bruteforce Ä‘Æ°á»£c thÃ¬ thá»­ decrypt flag. Náº¿u Ä‘Ãºng dáº¡ng cá»§a flag thÃ¬ dá»«ng khÃ´ng thÃ¬ tiáº¿p tá»¥c bruteforce rá»“i sáº½ tÃ¬m Ä‘Æ°á»£c flag. BÆ°á»›c nÃ y tiáº¿n hÃ nh offline nÃªn khÃ´ng cáº§n quan tÃ¢m Ä‘áº¿n serve limit thá»i gian. ğŸ˜ğŸ˜ğŸ˜ LÃ¢u ko chÆ¡i crypto nÃªn bÃ i Ä‘Æ¡n giáº£n tháº¿ nÃ y cÅ©ng khÃ´ng nghÄ© ra. CÃ³ láº½ vÃ¬ mÃ¬nh cÅ©ng khÃ´ng cÃ²n quÃ¡ táº­p trung vÃ o crypto ná»¯a r :))  



# END 


