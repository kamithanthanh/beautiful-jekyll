---
layout : post 
title : Nu1CTF 2019 Warmup Pwn 
---

ÄÃ¢y lÃ  bÃ i heap mÃ¬nh chÆ¡i tuáº§n trÆ°á»›c nhÆ°ng khÃ´ng lÃ m Ä‘Æ°á»£c.TÃ¬m Ä‘á»c [**writeup**](https://teamrocketist.github.io/2019/09/09/Pwn-N1CTF-2019-warmup/) váº­y ğŸ˜ğŸ˜ğŸ˜  Qua bÃ i nÃ y mÃ¬nh há»c Ä‘Æ°á»£c ráº¥t nhiá»u kiáº¿n thá»©c má»›i.Do dáº¡o nÃ y pháº£i Ä‘i há»c + Ä‘i lÃ m nÃªn cÅ©ng ko cÃ³ nhiá»u thá»i gian ráº£nh láº¯m. Má»—i hÃ´m update tÃ­ Ä‘á»ƒ hoÃ n thiá»‡n bÃ i nÃ y. Hope cuá»‘i tuáº§n lÃ  xong Ä‘á»ƒ chiáº¿n giáº£i tiáº¿p.  


# PhÃ¢n tÃ­ch tÄ©nh IDA  
ChÆ°Æ¡ng trÃ¬nh ráº¥t dá»… dá»‹ch ngÆ°á»£c. NÃ³ cÃ³ ba hÃ m cÆ¡ báº£n :  

![hinh1](/img/ctf/Nu1CTF/hinh1.png)  

![](/img/ctf/Nu1CTF/hinh2.png)   

![](/img/ctf/Nu1CTF/hinh3.png)  

NhÆ°ng cÅ©ng chÃ­nh vÃ¬ Ä‘Æ¡n giáº£n nÃªn táº¥n cÃ´ng nÃ³ cÅ©ng ráº¥t phá»©c táº¡p vÃ  Ä‘Ã²i há»i nhiá»u kÄ© thuáº­t.  

# Double Free  
ChÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ free má»™t chunk 2 láº§n liÃªn tiáº¿p. DÃ¹ cho con trá» heap trong node Ä‘Ã£ bá»‹ xÃ³a nhÆ°ng váº«n cÃ²n con trá» trong ```ptr```. ÄÃ¢y lÃ  má»™t lá»—i chÃºng ta cÃ³ thá»ƒ táº­n dá»¥ng.Do trÃªn báº£n libc 2.27 Ä‘Ã£ cÃ³ tcache, táº¥t cáº£ cÃ¡c chunk cÃ³ size < 0x410 Ä‘á»u Ä‘Æ°á»£c Ä‘Æ°a vÃ o tcache bins . Tcache bin sáº½ bá» qua táº¥t cáº£ cÃ¡c security check nÃªn khÃ´ng bá»‹ lá»—i double free.  
Khi tiáº¿n hÃ nh add 1 node thÃ¬ heap trá»Ÿ thÃ nh :  

![](/img/ctf/Nu1CTF/hinh4.PNG)  


Tá»©c lÃ  ta Ä‘Ã£ cÃ³ 1 fastbin. Sau khi double free thÃ¬ chunk Ä‘Æ°á»£c Ä‘áº·t vÃ o tcache bins.  
  - **Tcache bins** : A -> A  

![](/img/ctf/Nu1CTF/hinh5.PNG)  

Ta tháº¥y nhÆ° trÃªn hÃ¬nh thÃ¬ con trá» FD trá» vÃ o chÃ­nh A.Ta cÃ³ single linked list. Con trá» FD nÃ y láº¡i vÃ´ tÃ¬nh náº±m luÃ´n trong pháº§n Userdata cá»§a chunk cÅ©. Sau Ä‘Ã³ náº¿u ta tiáº¿n hÃ nh malloc thÃ¬ hÃ m malloc sáº½ cáº¥p phÃ¡t cho chÃºng ta bá»™ nhá»› táº¡i Ä‘á»‹a chá»‰ cá»§a A. ChÃºng ta cÃ³ quyá»n sá»­a Ä‘á»•i FD thÃ nh báº¥t kÃ¬ Ä‘á»‹a chá»‰ nÃ o chÃºng ta muá»‘n. VÃ  tcache bins sáº½ trá»Ÿ thÃ nh :  
  - **tcache bins** : A -> target_addr  

NhÆ°ng chÃºng ta chÆ°a biáº¿t Ä‘á»‹a chá»‰ nÃ o vÃ¬ cÃ³ PIE mÃ  láº¡i khÃ´ng cÃ³ hÃ m nÃ o Ä‘á»ƒ leak Ä‘á»‹a chá»‰. LÆ°u Ã½ má»™t Ä‘iá»ƒm lÃ  :  
```
ASLR khÃ´ng thay Ä‘á»•i 3 byte cuá»‘i cá»§a Ä‘á»‹a chá»‰.  
```
Tá»©c lÃ  3 byte cuá»‘i cÃ¹ng cá»§a Ä‘á»‹a chá»‰ heap trong con trá» FD lÃ  khÃ´ng Ä‘á»•i. VÃ¬ váº­y ta cÃ³ thá»ƒ chá»n target lÃ  Ä‘á»‹a chá»‰ heap báº±ng cÃ¡ch sá»­a Ä‘á»•i 3 byte nÃ y.   

# Leak libc  
ChÃºng ta chá»‰ Ä‘Æ°á»£c quyá»n malloc fastbin. NhÆ°ng vá»›i fastbin thÃ¬ khÃ´ng thá»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc. VÃ¬ váº­y chÃºng ta cáº§n tá»›i **unsorted bin**. Tá»« cÃ¡ch ghi Ä‘Ã¨ Ä‘á»‹a chá»‰ Ä‘Æ°á»£c tÃ¬m tháº¥y á»Ÿ trÃªn, ta sáº½ ghi Ä‘Ã¨ lÃªn byte cuá»‘i Ä‘á»‹a chá»‰ cá»§a A thÃ nh ```A_addr-0x10``` Ä‘á»ƒ nÃ³ malloc vá» vÃ¹ng nhá»› overlap Ä‘Æ°á»£c pháº§n size, pre_size. á» Ä‘Ã¢y ta tiáº¿n hÃ nh sá»­a byte Ä‘Ã³ tá»« ```0x51``` -> ```0x91```. Ta Ä‘Æ°á»£c 1 chunk unsorted bin.NhÆ°ng Ä‘á»‘i vá»›i unsorted bin thÃ¬ cÃ¡c cÆ¡ cháº¿ báº£o vá»‡ Ä‘Æ°á»£c check háº¿t sá»©c cháº·t cháº½. ğŸŒğŸŒğŸŒ Cho nÃªn cáº§n fake má»™t sá»‘ chunk á»Ÿ sau Ä‘á»ƒ pass cÃ¡c cÆ¡ cháº¿ báº£o vá»‡. Cá»¥ thá»ƒ lÃ  :  

```python 
add("a")      # 0  
add("b" * 0x30 + p64(0) + p64(0x51))    # 1 
add("c" * 0x30 + p64(0) + p64(0x1))     # 2 
delete(2) 
delete(1) 
delete(0) 
delete(0) 
# tcache bins[4] : 0x556a2e57e670 <- 0x556a2e57e670

# allocate to fix size 
add("\x70")       # tcache bins[3] : 0x556a2e57e670 <- 0x556a2e57e670
add("\x60")       # tcache bins[2] : 0x556a2e57e670 <- 0x556a2e57e660
add("\x60")       # tcache bins[1] : 0x556a2e57e660 
add("\x00")       # malloc to 0x556a2e57e660
```

CÃ³ thá»ƒ debug Ä‘á»ƒ tháº¥y rÃµ Ä‘Æ°á»£c Ä‘iá»u trÃªn.CÃ¡ch Ä‘á»ƒ bypass [PIE](https://hacmao.pw/Pwnable/heap/debug_pie/).  
Free chunk 1,2 chá»‰ mang tÃ­nh hÃ¬nh thá»©c Ä‘á»ƒ viá»‡c malloc chunk phÃ­a sau thuáº­n lá»£i. CÅ©ng cÃ³ thá»ƒ chá»‰ free 1 chunk thÃ¬ bá»›t 1 add, hoáº·c ko free chunk nÃ o thÃ¬ váº«n pháº£i add 3 chunk má»›i thÃ¬ má»›i vÃ´ Ä‘c cÃ¡i ```0x556a2e57e660```. ğŸ˜¬ğŸ˜¬ğŸ˜¬ Ráº¥t magic nhÆ°ng cá»© debug mÃ  nhÃ¬n thÃ´i.  
Sau khi vÃ o Ä‘Æ°á»£c chunk nhÆ° trÃªn ta tiáº¿n hÃ nh overwrite size :  
```python 
add(p64(0) + p64(0x91)) 
``` 
VÃ  káº¿t quáº£ :  

![](/img/ctf/Nu1CTF/hinh6.PNG)



