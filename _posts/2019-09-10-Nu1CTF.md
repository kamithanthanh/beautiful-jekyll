---
layout : post 
title : Nu1CTF 2019 Warmup Pwn 
---

ÄÃ¢y lÃ  bÃ i heap mÃ¬nh chÆ¡i tuáº§n trÆ°á»›c nhÆ°ng khÃ´ng lÃ m Ä‘Æ°á»£c.TÃ¬m Ä‘á»c [**writeup**](https://teamrocketist.github.io/2019/09/09/Pwn-N1CTF-2019-warmup/) váº­y ğŸ˜ğŸ˜ğŸ˜  Qua bÃ i nÃ y mÃ¬nh há»c Ä‘Æ°á»£c ráº¥t nhiá»u kiáº¿n thá»©c má»›i.Do dáº¡o nÃ y pháº£i Ä‘i há»c + Ä‘i lÃ m nÃªn cÅ©ng ko cÃ³ nhiá»u thá»i gian ráº£nh láº¯m. Má»—i hÃ´m update tÃ­ Ä‘á»ƒ hoÃ n thiá»‡n bÃ i nÃ y. Hope cuá»‘i tuáº§n lÃ  xong Ä‘á»ƒ chiáº¿n giáº£i tiáº¿p.  


# PhÃ¢n tÃ­ch tÄ©nh IDA  
ChÆ°Æ¡ng trÃ¬nh ráº¥t dá»… dá»‹ch ngÆ°á»£c. NÃ³ cÃ³ ba hÃ m cÆ¡ báº£n :  

![hinh1](/img/ctf/Nu1CTF/hinh1.png)  

![](/img/ctf/Nu1CTF/hinh2.png)   

![](/img/ctf/Nu1CTF/hinh3.png)  

NhÆ°ng cÅ©ng chÃ­nh vÃ¬ Ä‘Æ¡n giáº£n nÃªn táº¥n cÃ´ng nÃ³ cÅ©ng ráº¥t phá»©c táº¡p vÃ  Ä‘Ã²i há»i nhiá»u kÄ© thuáº­t.  

# Double Free  
ChÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ free má»™t chunk 2 láº§n liÃªn tiáº¿p. DÃ¹ cho con trá» heap trong node Ä‘Ã£ bá»‹ xÃ³a nhÆ°ng váº«n cÃ²n con trá» trong ```ptr```. ÄÃ¢y lÃ  má»™t lá»—i chÃºng ta cÃ³ thá»ƒ táº­n dá»¥ng.Do trÃªn báº£n libc 2.27 Ä‘Ã£ cÃ³ tcache, táº¥t cáº£ cÃ¡c chunk cÃ³ size < 0x410 Ä‘á»u Ä‘Æ°á»£c Ä‘Æ°a vÃ o tcache bins . Tcache bin sáº½ bá» qua táº¥t cáº£ cÃ¡c security check nÃªn khÃ´ng bá»‹ lá»—i double free.  
Khi tiáº¿n hÃ nh add 1 node thÃ¬ heap trá»Ÿ thÃ nh :  

![](/img/ctf/Nu1CTF/hinh4.PNG)  


Tá»©c lÃ  ta Ä‘Ã£ cÃ³ 1 fastbin. Sau khi double free thÃ¬ chunk Ä‘Æ°á»£c Ä‘áº·t vÃ o tcache bins.  
  - **Tcache bins** : A -> A  

![](/img/ctf/Nu1CTF/hinh5.PNG)  

Ta tháº¥y nhÆ° trÃªn hÃ¬nh thÃ¬ con trá» FD trá» vÃ o chÃ­nh A.Ta cÃ³ single linked list. Con trá» FD nÃ y láº¡i vÃ´ tÃ¬nh náº±m luÃ´n trong pháº§n Userdata cá»§a chunk cÅ©. Sau Ä‘Ã³ náº¿u ta tiáº¿n hÃ nh malloc thÃ¬ hÃ m malloc sáº½ cáº¥p phÃ¡t cho chÃºng ta bá»™ nhá»› táº¡i Ä‘á»‹a chá»‰ cá»§a A. ChÃºng ta cÃ³ quyá»n sá»­a Ä‘á»•i FD thÃ nh báº¥t kÃ¬ Ä‘á»‹a chá»‰ nÃ o chÃºng ta muá»‘n. VÃ  tcache bins sáº½ trá»Ÿ thÃ nh :  
  - **tcache bins** : A -> target_addr  

NhÆ°ng chÃºng ta chÆ°a biáº¿t Ä‘á»‹a chá»‰ nÃ o vÃ¬ cÃ³ PIE mÃ  láº¡i khÃ´ng cÃ³ hÃ m nÃ o Ä‘á»ƒ leak Ä‘á»‹a chá»‰. LÆ°u Ã½ má»™t Ä‘iá»ƒm lÃ  :  
```
ASLR khÃ´ng thay Ä‘á»•i 3 byte cuá»‘i cá»§a Ä‘á»‹a chá»‰.  
```
Tá»©c lÃ  3 byte cuá»‘i cÃ¹ng cá»§a Ä‘á»‹a chá»‰ heap trong con trá» FD lÃ  khÃ´ng Ä‘á»•i. VÃ¬ váº­y ta cÃ³ thá»ƒ chá»n target lÃ  Ä‘á»‹a chá»‰ heap báº±ng cÃ¡ch sá»­a Ä‘á»•i 3 byte nÃ y.   

# Leak libc  

## Fake unsorted bin

ChÃºng ta chá»‰ Ä‘Æ°á»£c quyá»n malloc fastbin. NhÆ°ng vá»›i fastbin thÃ¬ khÃ´ng thá»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ libc. VÃ¬ váº­y chÃºng ta cáº§n tá»›i **unsorted bin**. Tá»« cÃ¡ch ghi Ä‘Ã¨ Ä‘á»‹a chá»‰ Ä‘Æ°á»£c tÃ¬m tháº¥y á»Ÿ trÃªn, ta sáº½ ghi Ä‘Ã¨ lÃªn byte cuá»‘i Ä‘á»‹a chá»‰ cá»§a A thÃ nh ```A_addr-0x10``` Ä‘á»ƒ nÃ³ malloc vá» vÃ¹ng nhá»› overlap Ä‘Æ°á»£c pháº§n size, pre_size. á» Ä‘Ã¢y ta tiáº¿n hÃ nh sá»­a byte Ä‘Ã³ tá»« ```0x51``` -> ```0x91```. Ta Ä‘Æ°á»£c 1 chunk unsorted bin.NhÆ°ng Ä‘á»‘i vá»›i unsorted bin thÃ¬ cÃ¡c cÆ¡ cháº¿ báº£o vá»‡ Ä‘Æ°á»£c check háº¿t sá»©c cháº·t cháº½. ğŸŒğŸŒğŸŒ Cho nÃªn cáº§n fake má»™t sá»‘ chunk á»Ÿ sau Ä‘á»ƒ pass cÃ¡c cÆ¡ cháº¿ báº£o vá»‡. Cá»¥ thá»ƒ lÃ  :  

```python 
add("a")      # 0  
add("b" * 0x30 + p64(0) + p64(0x51))    # 1  
add("c" * 0x30 + p64(0) + p64(0x1))     # 2 
# hai chunk B, C lÃ  Ä‘á»ƒ pass Ä‘Æ°á»£c security check vá» sau
delete(2) 
delete(1) 
delete(0) 
delete(0) 
# tcache bins[4] : 0x556a2e57e670 <- 0x556a2e57e670

# allocate to fix size 
add("\x70")       # tcache bins[3] : 0x556a2e57e670 <- 0x556a2e57e670
add("\x60")       # tcache bins[2] : 0x556a2e57e670 <- 0x556a2e57e660
add("\x60")       # tcache bins[1] : 0x556a2e57e660 
add("\x00")       # malloc to 0x556a2e57e660
```

CÃ³ thá»ƒ debug Ä‘á»ƒ tháº¥y rÃµ Ä‘Æ°á»£c Ä‘iá»u trÃªn.CÃ¡ch Ä‘á»ƒ bypass [PIE](https://hacmao.pw/Pwnable/heap/debug_pie/).  
Free chunk 1,2 chá»‰ mang tÃ­nh hÃ¬nh thá»©c Ä‘á»ƒ viá»‡c malloc chunk phÃ­a sau thuáº­n lá»£i. CÅ©ng cÃ³ thá»ƒ chá»‰ free 1 chunk thÃ¬ bá»›t 1 add, hoáº·c ko free chunk nÃ o thÃ¬ váº«n pháº£i add 3 chunk má»›i thÃ¬ má»›i vÃ´ Ä‘c cÃ¡i ```0x556a2e57e660```. ğŸ˜¬ğŸ˜¬ğŸ˜¬ Ráº¥t magic nhÆ°ng cá»© debug mÃ  nhÃ¬n thÃ´i.  
Sau khi vÃ o Ä‘Æ°á»£c chunk nhÆ° trÃªn ta tiáº¿n hÃ nh overwrite size :  
```python 
add(p64(0) + p64(0x91)) 
``` 
VÃ  káº¿t quáº£ :  

![](/img/ctf/Nu1CTF/hinh6.PNG)   

Giá» khi free cÃ¡i unsorted bin nÃ y thÃ¬ chunk B, C lÃ  nhÃ¢n tá»‘ gank tem Ä‘á»ƒ bypass Ä‘Æ°á»£c security check.
Chunk C Ä‘á»ƒ bypass **double free(!prev)** :  

![](https://i.imgur.com/uGz3Eu9.png)  

VÃ¬ khi size cá»§a chunk A Ä‘Æ°á»£c fix thÃ nh ```0x91``` thÃ¬ nextchunk sáº½ trá» tá»›i pháº§n userdata cá»§a chunk B, nÆ¡i ta Ä‘Ã£ fake thÃ nh ```p64(0) p64(0x51)```. Bit cuá»‘i Ä‘Ã£ Ä‘Æ°á»£c set thÃ nh 1 nÃªn hoÃ n toÃ n thá»a mÃ£n check trÃªn.  

Chunk D Ä‘á»ƒ prevent viá»‡c unlink :  

![](https://i.imgur.com/Ir1dvEf.png)  

![](https://i.imgur.com/OqsTjG3.png)  

Fake size trong userdata cá»§a B pháº£i lÃ  0x51 vÃ¬ nÃ³ pháº£i trá» Ä‘áº¿n fakesize trong userdata cá»§a C Ä‘á»ƒ bypass Ä‘Æ°á»£c check trÃªn ko Ä‘i vÃ o unlink. NhÆ° váº­y sáº½ bypass Ä‘Æ°á»£c . Sau khi free ta cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a **main_arena** trong heap.Fakesize cá»§a chunk C chá»‰ cáº§n cÃ³ pre_bit_inuse = 1 lÃ  ok, khÃ´ng quan trá»ng lÃ  bao nhiÃªu.  

Sau khi fake Ä‘á»ƒ bypass security, chÃºng ta tiáº¿n hÃ nh free unsoredted bins chunk vá»«a táº¡o. LÆ°u Ã½ lÃ  cáº§n fill Ä‘áº§y tcache bins thÃ¬ chunk má»›i Ä‘Æ°á»£c Ä‘áº©y vÃ o unsorted bins :   
```python
for i in range(7) : 
  delete(0) 
delete(0) 
```
Sau Ä‘Ã³ ta Ä‘Æ°á»£c libc á» FD, BK :  

![](/img/ctf/Nu1CTF/hinh7.PNG)   

ÄÃ³ lÃ  ```0x7fee7ff60ca0 <main_arena+96>:	0x00005615ded5d750```  

## Dup into stdout -> leak libc  
Sau khi cÃ³ Ä‘Æ°á»£c libc trong stack thÃ¬ viá»‡c chÃºng ta hÆ°á»›ng tá»›i lÃ  kÄ© thuáº­t cá»§a angel boy, Ä‘Æ°á»£c Ä‘á» cáº­p trong bÃ i viáº¿t [nÃ y](https://vigneshsrao.github.io/babytcache/) . MÃ¬nh cÅ©ng sáº½ nghiá»‡m láº¡i sau :v  
CÃ³ má»™t Ä‘iá»ƒm lÃ  Ä‘á»ƒ dup Ä‘Æ°á»£c vá» stdout lÃ  Ä‘á»‹a chá»‰ Ä‘Æ°á»£c lÆ°u á»Ÿ FD, BK cá»§a chunk A, thÃ¬ nÃ³ cáº§n á»Ÿ trong tcache bins cÃ³ size lÃ  0x51. Do chÃºng ta chá»‰ Ä‘Æ°á»£c quyá»n malloc chunk cÃ³ size lÃ  0x51 thÃ´i. VÃ  do Ä‘Ã³ lÃ  chÃºng ta cáº§n sá»­a láº¡i size cá»§a chunk A vá» láº¡i nhÆ° cÅ© theo Ä‘Ãºng cÃ¡ch trÃªn ta Ä‘Ã£ lÃ m.  
Äá»“ng thá»i thÃ¬ chunk A pháº£i náº±m trong tcache bins. NhÆ°ng sau khi thá»±c hiá»‡n cÃ¡c bÆ°á»›c trÃªn thÃ¬ tcache bins cá»§a chÃºng ta hiá»‡n Ä‘ang trá»‘ng :  

![](/img/ctf/Nu1CTF/hinh8.PNG)   

Cho nÃªn chÃºng ta cáº§n free chunk A Ä‘á»ƒ Ä‘Æ°a chunk A vÃ o tcache bins size 0x51. NhÆ°ng náº¿u chÃºng ta free sau khi free unsorted bin thÃ¬ FD, BK sáº½ bá»‹ ghi Ä‘Ã¨ vÃ  máº¥t libc ğŸ˜±ğŸ˜±ğŸ˜± Cho nÃªn trÆ°á»›c bÆ°á»›c edit size Ä‘áº§u tiÃªn ta pháº£i free chunk A. ChÃºng ta cáº§n ```má»™t lá»—i double free``` Ä‘á»ƒ cÃ³ thá»ƒ ```dup into stack``` Ä‘Æ°á»£c. MÃ¬nh há»c lÃ  váº­y chá»© cÅ©ng chÆ°a rÃµ táº¡i sao láº¯m.  
Tá»•ng káº¿t láº¡i Ä‘á»ƒ dup Ä‘Æ°á»£c lÃªn Ä‘á»‹a chá»‰ mong muá»‘n thÃ¬ script pháº£i cÃ³ dáº¡ng :  

```python 
--malloc to 0x556a2e57e660--  
delete(0)   # double free 
delete(0) 
for i in range(7) : 
  delete(1)   # fills tcache bins 
delete(1)     # free into unsorted bin   
```  

Trá»Ÿ láº¡i Ä‘oáº¡n code trÃªn Ä‘á»ƒ malloc táº¡i sao láº¡i cáº§n free theo thá»© tá»± : ```2 -> 1 -> 0 -> 0``` . Äá»ƒ chÃºng ta cÃ³ Ä‘Æ°á»£c 3 con trá» cÃ¹ng chá»‰ tá»›i chunk A :  

```
add("\x70")       # 0x556a2e57e670  : 0 
add("\x60")       # 0x556a2e57e670  : 1 
add("\x60")       # 0x556a2e57e670  : 2 
```   
  - Chunk 0 : DÃ¹ng Ä‘á»ƒ free A vá» tcache bins size 0x51  
  - Chunk 1 : DÃ¹ng Ä‘á»ƒ free A vá» unsorted bin  
  - Chunk 2 : DÃ¹ng Ä‘á»ƒ edit giÃ¡ trá»‹  

Ok giá» cÃ³ thá»ƒ dup into libc Ä‘Æ°á»£c roÃ i. Trá»Ÿ láº¡i vá»›i kÄ© thuáº­t cá»§a ```angelboy```. ChÃºng ta cáº§n dup vá» Ä‘á»‹a chá»‰ cá»§a stdout.
Báº±ng cÃ¡ch dÃ¹ng ```edit(2)``` Ä‘á»ƒ sá»­a láº¡i vÃ i bytes cuá»‘i cá»§a libc ta sáº½ Ä‘Æ°á»£c stdout. ASLR khÃ´ng thay Ä‘á»•i 3 bytes cuá»‘i. MÃ  Ä‘á»‹a chá»‰ cá»§a libc main_arena chá»‰ khÃ¡c 4 byte so vá»›i Ä‘á»‹a chá»‰ cá»§a stdout. TrÃªn server lÃ  4 byte nhÆ°ng trÃªn local cá»§a mÃ¬nh thÃ¬ 5 bytes :vv Do Ä‘Ã³ trÃªn server chÃºng ta chá»‰ cáº§n bruteforce 1 byte lÃ  cÃ³ thá»ƒ dá»… dÃ ng sá»­a thÃ nh stdout.    

![](/img/ctf/Nu1CTF/hinh9.PNG)  

Sau khi dup into stdout, tiáº¿n hÃ nh ghi Ä‘Ã¨ lÃªn ```stdout->flags``` -> ```0xfbad1800```, Ä‘á»“ng thá»i ghi giÃ¡ trá»‹ NULL lÃªn ```_IO_read_ptr, _IO_read_end, _IO_read_base``` vÃ  last bytes cá»§a ```_IO_write_base```. Cá»¥ thá»ƒ payload khi ghi Ä‘Ã¨ cÃ³ dáº¡ng :   

```python
p64(0xfbad1800) + 3 * p64(0) + "\x00"
```   

Sau Ä‘Ã³ chÃºng ta leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a libc :  

![](/img/ctf/Nu1CTF/hinh10.PNG)   

Äá»‹a chá»‰ cá»§a libc báº¯t Ä‘áº§u báº±ng ```\x7f``` trá»« Ä‘i 1 sá»‘ offset nÃ o Ä‘Ã³.  

## Overwrite free hook to get shell  

Sau khi Ä‘Ã£ leak Ä‘Æ°á»£c libc thÃ¬ chÃºng ta táº­n dá»¥ng kÄ© thuáº­t ```tcachebin dupinto stack``` Ä‘á»ƒ overwrite ```free_hook``` báº±ng Ä‘á»‹a chá»‰ cá»§a ```system```.  
CÃ³ má»™t Ä‘iá»ƒm khÃ¡c cá»§a tcache so vá»›i fastbin lÃ  : khi free thÃ¬ con trá» FD trá» vÃ o vÃ¹ng user data cá»§a chunk chá»© khÃ´ng pháº£i tá»« vÃ¹ng size nhÆ° trong fastbin. Cho nÃªn ```tcachebin dupinto stack``` cÅ©ng khÃ´ng cáº§n pháº£i trá»« Ä‘i kÃ­ch thÆ°á»›c vÃ¹ng size nhÆ° trong ```fastbin dupinto stack```. CÅ©ng khÃ´ng cáº§n pháº£i fakesize .  
Sau khi Ä‘Ã£ ghi Ä‘Ã¨ Ä‘Æ°á»£c nhÆ° trÃªn thÃ¬ khi tiáº¿n hÃ nh free 1 chunk cÃ³ con trá» FD = "/bin/sh\x00" thÃ¬ chÃºng ta cÃ³ shell ğŸ˜ğŸ˜ğŸ˜  

## Angel Boy leak libc  

Sau khi ngÃ¢m cá»©u blog kia mÃ¬nh cÅ©ng hÃ¬nh dung Ä‘Æ°á»£c cÃ¡ch Ä‘á»ƒ leak Ä‘á»‹a chá»‰ khi thá»±c hiá»‡n script nhÆ° trÃªn.  
NÃ³i chÃºng trong hÃ m puts cÃ³ 1 function nhÆ° nÃ y :  

```c
int
_IO_new_file_overflow (_IO_FILE *f, int ch)
{
  if (f->_flags & _IO_NO_WRITES) /* SET ERROR */
    {
      f->_flags |= _IO_ERR_SEEN;
      __set_errno (EBADF);
      return EOF;
    }
  /* If currently reading or no buffer allocated. */
  if ((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL)
    {
      :
      :
    }
  if (ch == EOF)
    return _IO_do_write (f, f->_IO_write_base,  // our target
			 f->_IO_write_ptr - f->_IO_write_base);
```

ÄÃ¢y lÃ  target : ```_IO_do_write (f, f->_IO_write_base,  // our target
			 f->_IO_write_ptr - f->_IO_write_base); ```  
Thá»±c hiá»‡n ghi Ä‘Ã¨ lÃªn ```stdout-> flags = 0xfbad1800``` Ä‘á»ƒ qua táº¥t cáº£ cÃ¡c check Ä‘á»ƒ Ä‘áº¿n Ä‘Æ°á»£c target.  
Sau Ä‘Ã³ chÃºng ta ghi Ä‘Ã¨ 1 bytes "\x00" lÃªn bytes cuá»‘i cÃ¹ng cá»§a ```_IO_write_base``` Ä‘á»ƒ nÃ³ trá» sang má»™t Ä‘á»‹a chá»‰ trÆ°á»›c Ä‘á»‹a chá»‰ cáº§n in. Tá»« Ä‘Ã³ in thÃªm cho chÃºng ta má»™t sá»‘ thÃ´ng tin vá» Ä‘á»‹a chá»‰ cá»§a libc.   

![](/img/ctf/Nu1CTF/hinh10.PNG)   

NhÆ° ta tháº¥y trÃªn hÃ¬nh thÃ¬ bÃªn cáº¡nh nhá»¯ng Ä‘á»‹a chá»‰ bytes linh tinh thÃ¬ nÃ³ cÅ©ng in ra kÃ­ tá»± Ä‘Ã¡ng láº½ pháº£i in : ```done!```.  

