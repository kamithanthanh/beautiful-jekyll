---
layout : post 
title : Nu1CTF 2019 Warmup Pwn 
---

ÄÃ¢y lÃ  bÃ i heap mÃ¬nh chÆ¡i tuáº§n trÆ°á»›c nhÆ°ng khÃ´ng lÃ m Ä‘Æ°á»£c.TÃ¬m Ä‘á»c [**writeup**](https://teamrocketist.github.io/2019/09/09/Pwn-N1CTF-2019-warmup/) váº­y ğŸ˜ğŸ˜ğŸ˜  Qua bÃ i nÃ y mÃ¬nh há»c Ä‘Æ°á»£c ráº¥t nhiá»u kiáº¿n thá»©c má»›i.Do dáº¡o nÃ y pháº£i Ä‘i há»c + Ä‘i lÃ m nÃªn cÅ©ng ko cÃ³ nhiá»u thá»i gian ráº£nh láº¯m. Má»—i hÃ´m update tÃ­ Ä‘á»ƒ hoÃ n thiá»‡n bÃ i nÃ y. Hope cuá»‘i tuáº§n lÃ  xong Ä‘á»ƒ chiáº¿n giáº£i tiáº¿p.  


# PhÃ¢n tÃ­ch tÄ©nh IDA  
ChÆ°Æ¡ng trÃ¬nh ráº¥t dá»… dá»‹ch ngÆ°á»£c. NÃ³ cÃ³ ba hÃ m cÆ¡ báº£n :  

![hinh1](/img/ctf/Nu1CTF/hinh1.png)  

![](/img/ctf/Nu1CTF/hinh2.png)   

![](/img/ctf/Nu1CTF/hinh3.png)  

NhÆ°ng cÅ©ng chÃ­nh vÃ¬ Ä‘Æ¡n giáº£n nÃªn táº¥n cÃ´ng nÃ³ cÅ©ng ráº¥t phá»©c táº¡p vÃ  Ä‘Ã²i há»i nhiá»u kÄ© thuáº­t.  

# Double Free  
ChÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ free má»™t chunk 2 láº§n liÃªn tiáº¿p. DÃ¹ cho con trá» heap trong node Ä‘Ã£ bá»‹ xÃ³a nhÆ°ng váº«n cÃ²n con trá» trong ```ptr```. 
ÄÃ¢y lÃ  má»™t lá»—i chÃºng ta cÃ³ thá»ƒ táº­n dá»¥ng.  
Khi tiáº¿n hÃ nh add 1 node thÃ¬ heap trá»Ÿ thÃ nh :  

![](/img/ctf/Nu1CTF/hinh1.png)  


Tá»©c lÃ  ta Ä‘Ã£ cÃ³ 1 fastbin. Sau khi double free thÃ¬ chunk Ä‘Æ°á»£c Ä‘áº·t vÃ o tcache bins.  
  - **Tcache bins** : A -> A  

![](/img/ctf/Nu1CTF/hinh5.png)  

Ta tháº¥y nhÆ° trÃªn hÃ¬nh thÃ¬ con trá» FD trá» vÃ o chÃ­nh A.Ta cÃ³ single linked list. Con trá» FD nÃ y láº¡i vÃ´ tÃ¬nh náº±m luÃ´n trong pháº§n Userdata cá»§a chunk cÅ©. Sau Ä‘Ã³ náº¿u ta tiáº¿n hÃ nh malloc thÃ¬ hÃ m malloc sáº½ cáº¥p phÃ¡t cho chÃºng ta bá»™ nhá»› táº¡i Ä‘á»‹a chá»‰ cá»§a A. ChÃºng ta cÃ³ quyá»n sá»­a Ä‘á»•i FD thÃ nh báº¥t kÃ¬ Ä‘á»‹a chá»‰ nÃ o chÃºng ta muá»‘n. VÃ  tcache bins sáº½ trá»Ÿ thÃ nh :  
  - **tcache bins** : A -> target_addr  
NhÆ°ng chÃºng ta chÆ°a biáº¿t Ä‘á»‹a chá»‰ nÃ o vÃ¬ cÃ³ PIE mÃ  láº¡i khÃ´ng cÃ³ hÃ m nÃ o Ä‘á»ƒ leak Ä‘á»‹a chá»‰. LÆ°u Ã½ má»™t Ä‘iá»ƒm lÃ  :  
```
ASLR khÃ´ng thay Ä‘á»•i 3 byte cuá»‘i cá»§a Ä‘á»‹a chá»‰.  
```
Tá»©c lÃ  3 byte cuá»‘i cÃ¹ng cá»§a Ä‘á»‹a chá»‰ heap trong con trá» FD lÃ  khÃ´ng Ä‘á»•i. VÃ¬ váº­y ta cÃ³ thá»ƒ chá»n target lÃ  Ä‘á»‹a chá»‰ heap báº±ng cÃ¡ch sá»­a Ä‘á»•i 3 byte nÃ y.  

